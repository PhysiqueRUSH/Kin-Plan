<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b1120">
<link rel="manifest" href="manifest.json">
<title>Kin√©Plan</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0b1120;--bg2:#111827;--bg3:#1a2540;--cd:#151f35;--bd:#1e2d4a;--bd2:#2a3f66;--tx:#e2e8f0;--tx2:#7a8baa;--tx3:#4a5a78;--grn:#00d4aa;--grn2:#00b490;--grnd:rgba(0,212,170,.12);--blu:#38a3ff;--blud:rgba(56,163,255,.12);--org:#ff9f43;--orgd:rgba(255,159,67,.12);--red:#ff5274;--redd:rgba(255,82,116,.12);--ylw:#f0c040;--ylwd:rgba(240,192,64,.12);--pur:#a78bfa;--purd:rgba(167,139,250,.12);--r:10px;--r2:14px;--sh:0 4px 20px rgba(0,0,0,.35)}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100dvh;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--bd);border-radius:3px}
input,select,textarea,button{font-family:inherit}
.top{position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--bd);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.top h1{font-family:'JetBrains Mono',monospace;font-size:1.15rem;background:linear-gradient(135deg,var(--grn),var(--blu));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.top-r{display:flex;align-items:center;gap:10px}
.top-sub{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--tx2)}
.top-gear{background:none;border:none;font-size:1.2rem;cursor:pointer;padding:4px}
.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bd);overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:none;padding:11px 12px;font-size:.68rem;font-weight:600;color:var(--tx2);background:0;border:0;cursor:pointer;position:relative;white-space:nowrap;transition:.15s}
.tab.on{color:var(--grn)}.tab.on::after{content:'';position:absolute;bottom:0;left:12%;right:12%;height:2px;background:var(--grn);border-radius:2px}
.pnl{display:none;padding:14px 14px 110px}.pnl.on{display:block;animation:fi .2s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1}}
.card{background:var(--cd);border:1px solid var(--bd);border-radius:var(--r2);padding:14px;margin-bottom:11px;box-shadow:var(--sh)}
.card-t{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--grn);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.uz{border:2px dashed var(--bd);border-radius:var(--r2);padding:20px 14px;text-align:center;cursor:pointer;transition:.2s;background:var(--bg2)}
.uz:hover,.uz.dg{border-color:var(--grn);background:var(--grnd)}
.uz input{display:none}.uz .ui{font-size:1.6rem;margin-bottom:4px}
.uz p{font-size:.8rem;color:var(--tx2)}.uz .sub{font-size:.65rem;color:var(--tx3);margin-top:2px}
.pb{height:3px;background:var(--bg3);border-radius:3px;overflow:hidden;margin:10px 0}
.pf{height:100%;background:linear-gradient(90deg,var(--grn),var(--blu));border-radius:3px;transition:width .3s;width:0}
.pi{display:flex;align-items:center;padding:9px 10px;border-radius:8px;margin-bottom:3px;background:var(--bg2);border:1px solid transparent;transition:.12s;gap:8px;cursor:pointer}
.pi:hover{border-color:var(--bd)}
.pi .tm{font-family:'JetBrains Mono',monospace;font-size:.66rem;color:var(--tx2);min-width:38px}
.pi .nm{flex:1;font-size:.82rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tg{font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:5px;letter-spacing:.3px;white-space:nowrap}
.tg-j{background:var(--grnd);color:var(--grn)}.tg-l{background:var(--blud);color:var(--blu)}.tg-s{background:var(--orgd);color:var(--org)}.tg-f{background:var(--redd);color:var(--red)}.tg-ok{background:var(--grnd);color:var(--grn)}.tg-y{background:var(--ylwd);color:var(--ylw)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:9px 16px;border:0;border-radius:8px;font-size:.8rem;font-weight:600;cursor:pointer;transition:.12s;font-family:inherit}
.btn-p{background:linear-gradient(135deg,var(--grn),var(--grn2));color:var(--bg)}.btn-p:hover{filter:brightness(1.1)}
.btn-s{background:var(--bg3);color:var(--tx);border:1px solid var(--bd)}.btn-d{background:var(--redd);color:var(--red);border:1px solid rgba(255,82,116,.2)}
.btn-sm{padding:6px 10px;font-size:.7rem}.btn-bk{width:100%}
.btn-icon{background:none;border:1px solid var(--bd);color:var(--tx2);width:30px;height:30px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.85rem;cursor:pointer;flex-shrink:0;transition:.12s}
.btn-icon:hover{border-color:var(--grn);color:var(--grn)}
.al{padding:10px 12px;border-radius:var(--r);margin-bottom:10px;font-size:.76rem;display:flex;align-items:flex-start;gap:8px;animation:si .25s ease;flex-wrap:wrap}
@keyframes si{from{opacity:0;transform:translateX(-8px)}}
.al-w{background:var(--ylwd);border:1px solid rgba(240,192,64,.3);color:var(--ylw)}
.al-d{background:var(--redd);border:1px solid rgba(255,82,116,.3);color:var(--red)}
.al-i{background:var(--blud);border:1px solid rgba(56,163,255,.3);color:var(--blu)}
.al-g{background:var(--grnd);border:1px solid rgba(0,212,170,.3);color:var(--grn)}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);z-index:200;display:flex;align-items:center;justify-content:center;padding:14px;animation:fi .12s ease}
.ml{background:var(--bg2);border:1px solid var(--bd);border-radius:16px;padding:20px;max-width:460px;width:100%;max-height:88vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ml h3{font-family:'JetBrains Mono',monospace;font-size:.92rem;margin-bottom:12px;color:var(--grn)}
.ml p{font-size:.8rem;color:var(--tx2);margin-bottom:10px}
.ma{display:flex;gap:7px;margin-top:14px;justify-content:flex-end;flex-wrap:wrap}
.si{width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--bd);border-radius:8px;color:var(--tx);font-size:.8rem;outline:0;margin-bottom:10px}
.si:focus{border-color:var(--grn)}.si::placeholder{color:var(--tx3)}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:10px}
.sc{background:var(--bg2);border:1px solid var(--bd);border-radius:10px;padding:12px;text-align:center}
.sv{font-family:'JetBrains Mono',monospace;font-size:1.3rem;font-weight:700}
.sl{font-size:.65rem;color:var(--tx2);margin-top:3px}
.tgr{display:flex;gap:3px;background:var(--bg);border-radius:8px;padding:3px;margin-bottom:10px}
.tgb{flex:1;padding:7px;border:0;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;background:0;color:var(--tx2);transition:.12s}
.tgb.on{background:var(--cd);color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.ck{width:20px;height:20px;border-radius:5px;border:2px solid var(--bd);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.12s;flex-shrink:0}
.ck.on{background:var(--grn);border-color:var(--grn)}.ck.on::after{content:'\2713';color:var(--bg);font-size:.68rem;font-weight:700}
.sh{display:flex;justify-content:space-between;align-items:center;margin:14px 0 6px}
.sh h3{font-size:.72rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px}
.thr{display:flex;gap:6px;overflow-x:auto;padding:6px 0}
.th{width:48px;height:64px;border-radius:5px;object-fit:cover;border:2px solid var(--bd);flex-shrink:0}
.th.proc{opacity:.4;animation:pls 1s infinite}@keyframes pls{50%{opacity:.2}}
.toc{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:300;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.to{background:var(--cd);border:1px solid var(--bd);padding:9px 16px;border-radius:10px;font-size:.76rem;box-shadow:0 8px 30px rgba(0,0,0,.45);animation:ti .25s ease,tout .25s ease 2.7s forwards;pointer-events:auto;white-space:nowrap}
@keyframes ti{from{opacity:0;transform:translateY(-16px)}}@keyframes tout{to{opacity:0;transform:translateY(-16px)}}

/* Calendar */
.cal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.cal-hdr span{font-family:'JetBrains Mono',monospace;font-size:.82rem;font-weight:600}
.cal-hdr button{background:var(--bg3);border:1px solid var(--bd);color:var(--tx);width:28px;height:28px;border-radius:6px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center}
.cal-hdr button:disabled{opacity:.3;cursor:default}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day{font-size:.58rem;text-align:center;color:var(--tx3);padding:3px 0;font-weight:600}
.cal-cell{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:6px;font-size:.68rem;cursor:pointer;position:relative;transition:.12s;border:1px solid transparent;user-select:none}
.cal-cell:hover{border-color:var(--bd)}.cal-cell.today{border-color:var(--grn);background:var(--grnd)}.cal-cell.other{opacity:.25;cursor:default;pointer-events:none}
.cal-cell .dots{display:flex;gap:1.5px;margin-top:1px}.cal-cell .dot{width:4px;height:4px;border-radius:50%}
.cal-cell.low-day{background:rgba(56,163,255,.07)}
.cal-cell.has-spec{border-color:var(--pur);background:var(--purd)}
.cal-cell.pending-add{border-color:var(--pur);background:rgba(167,139,250,.25);animation:pls .8s infinite}
.cal-cell.pending-rm{border-color:var(--red);opacity:.5;text-decoration:line-through}
.cal-edit-bar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin-top:10px;padding:10px;background:var(--bg);border:1px solid var(--bd);border-radius:10px}
.cal-edit-bar .info{font-size:.72rem;color:var(--tx2);flex:1}
.cal-edit-bar .cnt{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--pur);font-weight:700}
.lgd{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0;font-size:.65rem;color:var(--tx2)}
.lgd span{display:flex;align-items:center;gap:3px}.lgd .ldot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dash-hero{background:linear-gradient(135deg,var(--bg3),var(--cd));border:1px solid var(--bd);border-radius:16px;padding:20px;margin-bottom:14px;text-align:center}
.dash-hero h2{font-family:'JetBrains Mono',monospace;font-size:1rem;margin-bottom:4px}
.dash-hero .sub{font-size:.75rem;color:var(--tx2)}
.dash-actions{display:flex;gap:8px;margin-top:14px;justify-content:center;flex-wrap:wrap}
.dash-section{margin-top:14px}.dash-section h3{font-size:.75rem;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;font-weight:600}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--bd);gap:10px}
.setting-row:last-child{border:none}.setting-label{font-size:.82rem}.setting-sub{font-size:.68rem;color:var(--tx2)}
.day-chips{display:flex;gap:4px;flex-wrap:wrap}
.day-chip{padding:5px 10px;border-radius:6px;font-size:.7rem;font-weight:600;cursor:pointer;border:1px solid var(--bd);background:var(--bg);color:var(--tx2);transition:.12s}
.day-chip.on{background:var(--grnd);color:var(--grn);border-color:var(--grn)}
.ey{text-align:center;padding:36px 18px;color:var(--tx2)}.ey .em{font-size:2rem;margin-bottom:8px}.ey p{font-size:.8rem}
.ocr-item{display:flex;align-items:center;gap:6px;padding:6px;border-radius:8px;background:var(--bg);border:1px solid var(--bd);margin-bottom:3px}
.ocr-item input{flex:1;background:transparent;border:none;color:var(--tx);font-size:.8rem;outline:none;font-family:inherit}
.ocr-item .ocr-time input{width:50px;text-align:center;font-family:'JetBrains Mono',monospace;font-size:.68rem}
.ocr-item .ocr-del{background:none;border:none;color:var(--red);cursor:pointer;font-size:.85rem;padding:2px 4px}
@media(min-width:560px){.pnl{max-width:520px;margin:0 auto}}
</style>
</head>
<body>
<div class="top"><h1>Kin√©Plan</h1><div class="top-r"><span class="top-sub" id="topDate"></span><button class="top-gear" onclick="switchTab('settings')">‚öôÔ∏è</button></div></div>
<div class="tabs">
  <button class="tab on" data-t="dash">üè†</button>
  <button class="tab" data-t="upload">üì∑ Upload</button>
  <button class="tab" data-t="groups">üë• Groupes</button>
  <button class="tab" data-t="billing">üí≥ Facturer</button>
  <button class="tab" data-t="sports">üèÉ Sportifs</button>
  <button class="tab" data-t="history">üìÖ Calendrier</button>
  <button class="tab" data-t="settings" style="display:none"></button>
</div>
<div class="toc" id="toasts"></div>

<div class="pnl on" id="p-dash">
  <div class="dash-hero"><h2 id="dashGreet">Bonjour üëã</h2><div class="sub" id="dashDate"></div>
    <div class="dash-actions"><button class="btn btn-p btn-sm" onclick="switchTab('upload')">üì∑ Importer</button><button class="btn btn-s btn-sm" onclick="switchTab('billing')">üí≥ Facturation</button></div></div>
  <div class="sg" id="dashStats"></div><div class="dash-section" id="dashAlerts"></div><div class="dash-section" id="dashToBill"></div><div class="dash-section" id="dashSport"></div>
</div>

<div class="pnl" id="p-upload">
  <div class="card"><div class="card-t">üì∑ Captures Patients (Doctolib)</div>
    <div class="uz" id="uzPat"><input type="file" accept="image/*" multiple id="fPat"><div class="ui">üì±</div><p>Importer captures Doctolib</p><div class="sub">Jusqu'√† 5 captures</div></div>
    <div class="thr" id="thPat"></div><div class="pb" id="pbPat" style="display:none"><div class="pf" id="pfPat"></div></div><div id="stPat" style="font-size:.7rem;color:var(--tx2);margin-top:6px"></div></div>
  <div class="card"><div class="card-t">üèÉ Captures Sportifs (WhatsApp)</div>
    <div class="uz" id="uzSpo"><input type="file" accept="image/*" multiple id="fSpo"><div class="ui">üí¨</div><p>Importer captures WhatsApp</p><div class="sub">Jusqu'√† 2 captures</div></div>
    <div class="thr" id="thSpo"></div><div class="pb" id="pbSpo" style="display:none"><div class="pf" id="pfSpo"></div></div><div id="stSpo" style="font-size:.7rem;color:var(--tx2);margin-top:6px"></div></div>
  <button class="btn btn-p btn-bk" id="btnGo" style="display:none">üîç V√©rifier les r√©sultats OCR</button>
</div>

<div class="pnl" id="p-groups"><div id="alGrp"></div>
  <div class="sg"><div class="sc"><div class="sv" style="color:var(--grn)" id="cJ">0</div><div class="sl">Jour J</div></div><div class="sc"><div class="sv" style="color:var(--blu)" id="cL">0</div><div class="sl">Lendemain</div></div></div>
  <input class="si" placeholder="üîç Rechercher..." id="srGrp"><div class="tgr" id="tgrGrp"><button class="tgb on" data-f="all">Tous</button><button class="tgb" data-f="jourj">Jour J</button><button class="tgb" data-f="lendemain">J+1</button></div>
  <div id="grpList"></div><button class="btn btn-s btn-bk" style="margin-top:10px" onclick="modalAddPat()">‚ûï Ajouter patient</button></div>

<div class="pnl" id="p-billing"><div class="card"><div class="card-t">üí≥ √Ä facturer aujourd'hui</div>
  <p style="font-size:.72rem;color:var(--tx2);margin-bottom:10px" id="billInfo"></p><div id="billList"></div></div>
  <div class="card"><div class="card-t">‚úÖ Factur√©s aujourd'hui</div><div id="billedList"></div></div></div>

<div class="pnl" id="p-sports"><div class="card"><div class="card-t">üèÉ Sportifs du jour</div><div id="spoList"></div></div>
  <div class="card"><div class="card-t">üí≥ Carte Vitale Sportif</div><div id="spoBill"></div></div></div>

<div class="pnl" id="p-history"><input class="si" placeholder="üîç Rechercher..." id="srHist"><div id="histList"></div></div>

<div class="pnl" id="p-settings">
  <div class="card"><div class="card-t">‚öôÔ∏è Param√®tres</div>
    <div class="setting-row"><div><div class="setting-label">Jours de facturation patients</div><div class="setting-sub">Jours o√π l'appli propose la facturation</div></div></div>
    <div class="day-chips" id="billDays" style="padding:8px 0"></div>
    <div class="setting-row"><div><div class="setting-label">Fr√©quence Jour J</div><div class="setting-sub">S√©ances entre factures</div></div><input type="number" class="si" id="freqJ" style="width:60px;margin:0;text-align:center" min="1" max="20"></div>
    <div class="setting-row"><div><div class="setting-label">Fr√©quence Lendemain</div><div class="setting-sub">S√©ances entre factures</div></div><input type="number" class="si" id="freqL" style="width:60px;margin:0;text-align:center" min="1" max="20"></div>
    <div class="setting-row"><div><div class="setting-label">Max CV par heure</div><div class="setting-sub">Heures de s√©ance Doctolib</div></div><input type="number" class="si" id="maxCVH" style="width:60px;margin:0;text-align:center" min="1" max="10"></div>
    <button class="btn btn-p btn-bk" style="margin-top:12px" onclick="saveSettings()">üíæ Enregistrer</button></div>
  <div class="card"><div class="card-t">üì§ Export</div><div style="display:flex;gap:8px"><button class="btn btn-s btn-sm" onclick="exportCSV()">üìä CSV</button><button class="btn btn-s btn-sm" onclick="exportJSON()">üíæ JSON</button></div></div>
  <div class="card"><div class="card-t">üóëÔ∏è Donn√©es</div><button class="btn btn-d btn-sm" onclick="confirmClear()">Tout effacer</button></div></div>

<div id="moCont"></div>

<script>
var SK='kineplan4',DN=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'],DNF=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'],MN=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
var MASTERS=['ARNALDI Bastien','BREMOND Mathieu','CHALMET Anne-Dominique','COQUILLARD Damien','COQUILLARD Leslie','COUVREUX Jonathan','DJEFFEL Christophe','FIENGO Magali','GIUGIARO Myl\u00e8ne','GOGLIA Olivier','GOUVRY Philippe','GUERIN Emma','MARCHAND Philippe','REMY Thibault','ROGER Jean-Baptiste','ROSTE Elsa'];

function ld(){try{var d=JSON.parse(localStorage.getItem(SK));if(d&&d.patients)return d}catch(e){}return{patients:{},sportifs:{},dailyBills:{},settings:{billDays:[1,4],freqJ:3,freqL:5,maxCVH:3},lastUpload:null}}
function sv(){localStorage.setItem(SK,JSON.stringify(DB))}
var DB=ld();
if(!DB.settings)DB.settings={billDays:[1,4],freqJ:3,freqL:5,maxCVH:3};
if(!DB.settings.billDays)DB.settings.billDays=[1,4];if(!DB.settings.freqJ)DB.settings.freqJ=3;if(!DB.settings.freqL)DB.settings.freqL=5;if(!DB.settings.maxCVH)DB.settings.maxCVH=3;
for(var mi=0;mi<MASTERS.length;mi++){var mid=pid(MASTERS[mi]);if(!DB.sportifs[mid])DB.sportifs[mid]={name:MASTERS[mi],sessions:[],billings:[],special:[]}}
sv();

function td(){return new Date().toISOString().slice(0,10)}
function tdFr(){var d=new Date();return DN[d.getDay()]+' '+d.getDate()+' '+MN[d.getMonth()].slice(0,4)+'. '+d.getFullYear()}
function dow(){return new Date().getDay()}
function isBD(){return DB.settings.billDays.indexOf(dow())>=0}
function nxtD(s){var d=new Date(s);d.setDate(d.getDate()+1);return d.toISOString().slice(0,10)}
function pDate(g){return g==='jourj'?td():nxtD(td())}
function pid(n){return n.trim().toUpperCase().replace(/[^A-Z\u00C0-\u00FF0-9]/g,'_').replace(/_+/g,'_')}
function act(p){if(!p||!p.sessions||!p.sessions.length)return false;return(new Date(td())-new Date(p.sessions[p.sessions.length-1]))/864e5<14}

// Total sessions = normal + special (both count for billing frequency)
function totalSessions(p){return(p.sessions||[]).concat(p.special||[])}
function sessionsSinceBill(p){
  var all=totalSessions(p).sort();
  var lb=p.billings&&p.billings.length?p.billings[p.billings.length-1]:null;
  if(!lb)return all.length;
  return all.filter(function(s){return s>lb}).length;
}

function toast(m,t){var e=document.createElement('div');e.className='to';if(t==='ok')e.style.borderColor='var(--grn)';else if(t==='err')e.style.borderColor='var(--red)';e.textContent=m;document.getElementById('toasts').appendChild(e);setTimeout(function(){e.remove()},3100)}
function modal(h){document.getElementById('moCont').innerHTML='<div class="mo" onclick="if(event.target===this)closeM()"><div class="ml">'+h+'</div></div>'}
function closeM(){document.getElementById('moCont').innerHTML=''}
function cfm(t,m,fn){modal('<h3>'+t+'</h3><p>'+m+'</p><div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="_cb">Confirmer</button></div>');document.getElementById('_cb').onclick=function(){closeM();fn()}}

// Tabs
document.getElementById('topDate').textContent=tdFr();
document.querySelectorAll('.tab').forEach(function(t){t.onclick=function(){switchTab(t.dataset.t)}});
function switchTab(n){document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('on',t.dataset.t===n)});document.querySelectorAll('.pnl').forEach(function(p){p.classList.toggle('on',p.id==='p-'+n)});var fn={dash:renderDash,groups:renderGrp,billing:renderBill,sports:renderSpo,history:renderHist,settings:renderSettings};if(fn[n])fn[n]()}

// OCR
var ocrW=null;
async function initOCR(){if(ocrW)return ocrW;ocrW=await Tesseract.createWorker('fra');return ocrW}
function parseDoc(txt){
  var pts=[],lines=txt.split('\n').map(function(l){return l.trim()}).filter(Boolean),skip=/^(Agenda|T\u00e2ches|Messagerie|Connect|Lundi|Mardi|Mercredi|Jeudi|Vendredi|Samedi|Dimanche|Absence)/i,ct='';
  for(var i=0;i<lines.length;i++){var l=lines[i];if(skip.test(l))continue;
    var tm=l.match(/^(\d{1,2})[:\.](\d{2})$/);if(tm){ct=tm[1].padStart(2,'0')+':'+tm[2];continue}
    var nm=l.match(/^([A-Z\u00C0-\u00DC][A-Z\u00C0-\u00DC\s\-']{1,})\s+([A-Z\u00C0-\u00DCa-z\u00E0-\u00FF][a-z\u00E0-\u00FFA-Z\-']*)/);
    if(nm){var full=nm[1].trim()+' '+nm[2].trim();if(!/^(Lundi|Mar)/i.test(full))pts.push({name:full,time:ct||'??:??'})}
    var inl=l.match(/^(\d{1,2})[:\.](\d{2})\s+([A-Z\u00C0-\u00DC].*\s+[A-Za-z\u00C0-\u00FF\-']+)/);
    if(inl)pts.push({name:inl[3].trim(),time:inl[1].padStart(2,'0')+':'+inl[2]})}
  var seen={};return pts.filter(function(p){var k=pid(p.name);if(seen[k])return false;seen[k]=1;return true})}

function matchSpo(raw){
  var rn=raw.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''),best=null,bs=0;
  for(var i=0;i<MASTERS.length;i++){var mn=MASTERS[i].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''),parts=mn.split(/\s+/),fn=parts[parts.length-1],ln=parts.slice(0,-1).join(' '),sc=0;
    if(rn===mn)sc=100;
    var rp=rn.split(/\s+/).filter(function(w){return w!=='sport'&&w!=='sports'&&w.length>0});
    for(var j=0;j<rp.length;j++){var w=rp[j];if(w===fn)sc+=50;else if(fn.startsWith(w)&&w.length>2)sc+=35;if(w===ln)sc+=45;else if(ln.startsWith(w)&&w.length>2)sc+=30;if(w.length===1&&ln.startsWith(w))sc+=20}
    var rnJ=rn.replace(/[\s\-]+/g,''),fnJ=fn.replace(/[\s\-]+/g,'');if(fnJ.startsWith(rnJ)&&rnJ.length>3)sc+=38;
    if(rp.length===1&&rp[0].length>3){if(fn===rp[0])sc+=50;if(ln===rp[0])sc+=45}
    if(sc>bs){bs=sc;best=MASTERS[i]}}return bs>=25?best:null}

function parseWA(txt){
  var names=[],lines=txt.split('\n').map(function(l){return l.trim()}).filter(Boolean);
  for(var i=0;i<lines.length;i++){var cl=lines[i].replace(/Hier,?\s*\d{1,2}:\d{2}/gi,'').replace(/Votes du sondage/gi,'').replace(/^\d{1,2}[:\.\s]*\d{0,2}\s*/,'').trim();
    if(cl.length<2||cl.length>50)continue;if(/^(en ligne|hier|aujourd|vu |message|tap|appel|photo|video|vocal|Audio|Doc|\+?\d{3,}|[@]|\d+\s*[\u2605\u2B50])/i.test(cl))continue;
    if(!/[a-zA-Z\u00C0-\u00FF]{2,}/.test(cl))continue;cl=cl.replace(/[\u26A0\uFE0F\u{1F4CB}\u{1F5D1}\u2753\u{1F4CE}\u{1F512}\u{1F3A4}]/gu,'').replace(/[\u{1F600}-\u{1FAFF}\u{2600}-\u{27BF}]/gu,'').trim();
    if(cl.length>1)names.push(cl)}
  return names.filter(function(v,i,a){return a.indexOf(v)===i})}

// Upload
var pendPat=[],pendSpo=[];
function setupUZ(zid,fid,type){var z=document.getElementById(zid),f=document.getElementById(fid);z.onclick=function(){f.click()};z.ondragover=function(e){e.preventDefault();z.classList.add('dg')};z.ondragleave=function(){z.classList.remove('dg')};z.ondrop=function(e){e.preventDefault();z.classList.remove('dg');doF(e.dataTransfer.files,type)};f.onchange=function(){doF(f.files,type)}}
async function doF(fl,type){
  var files=Array.from(fl).slice(0,type==='pat'?5:2);if(!files.length)return;
  var thE=document.getElementById(type==='pat'?'thPat':'thSpo'),pbE=document.getElementById(type==='pat'?'pbPat':'pbSpo'),pfE=document.getElementById(type==='pat'?'pfPat':'pfSpo'),stE=document.getElementById(type==='pat'?'stPat':'stSpo');
  thE.innerHTML='';pbE.style.display='block';
  for(var i=0;i<files.length;i++){var img=document.createElement('img');img.className='th proc';img.src=URL.createObjectURL(files[i]);thE.appendChild(img)}
  stE.textContent='\u23F3 Initialisation OCR...';var w=await initOCR();var all=[];
  for(var i=0;i<files.length;i++){stE.textContent='\u23F3 Analyse '+(i+1)+'/'+files.length+'...';pfE.style.width=(i/files.length*100)+'%';
    try{var r=await w.recognize(files[i]);if(type==='pat')all=all.concat(parseDoc(r.data.text));else all=all.concat(parseWA(r.data.text))}catch(e){console.error(e)}
    if(thE.children[i])thE.children[i].classList.remove('proc');pfE.style.width=((i+1)/files.length*100)+'%'}
  if(type==='pat'){var seen={};pendPat=all.filter(function(p){var k=pid(p.name);if(seen[k])return false;seen[k]=1;return true});stE.textContent='\u2705 '+pendPat.length+' patients'}
  else{var matched=[];for(var j=0;j<all.length;j++){var m=matchSpo(all[j]);if(m&&matched.indexOf(m)<0)matched.push(m)}pendSpo=matched;stE.textContent='\u2705 '+pendSpo.length+' sportifs'}
  if(pendPat.length||pendSpo.length)document.getElementById('btnGo').style.display='block'}
setupUZ('uzPat','fPat','pat');setupUZ('uzSpo','fSpo','spo');

// OCR Review
document.getElementById('btnGo').onclick=function(){showOCR()};
var dynIdx=0;
function showOCR(){
  var h='<h3>\uD83D\uDD0D V\u00e9rification OCR</h3><p>Corrigez puis validez.</p>';
  if(pendPat.length){h+='<div style="font-size:.75rem;font-weight:600;color:var(--grn);margin:10px 0 6px">PATIENTS ('+pendPat.length+')</div><div id="ocrPL">';
    for(var i=0;i<pendPat.length;i++)h+='<div class="ocr-item"><span class="ocr-time"><input value="'+pendPat[i].time+'" id="ot_'+i+'"></span><input value="'+pendPat[i].name+'" id="on_'+i+'"><button class="ocr-del" onclick="this.closest(\'.ocr-item\').style.display=\'none\';document.getElementById(\'on_'+i+'\').value=\'\'">\u2715</button></div>';
    h+='</div><button class="btn btn-s btn-sm" style="margin-top:6px" onclick="ocrAdd()">\u2795 Ajouter</button>'}
  if(pendSpo.length){h+='<div style="font-size:.75rem;font-weight:600;color:var(--org);margin:14px 0 6px">SPORTIFS ('+pendSpo.length+')</div>';
    for(var j=0;j<pendSpo.length;j++)h+='<div class="pi" style="cursor:default"><span class="nm">'+pendSpo[j]+'</span><span class="tg tg-s">SPORT</span></div>'}
  h+='<div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="ocrOK">\u2705 Valider</button></div>';
  modal(h);
  document.getElementById('ocrOK').onclick=function(){
    var corr=[];for(var i=0;i<pendPat.length;i++){var ne=document.getElementById('on_'+i),te=document.getElementById('ot_'+i);if(ne&&ne.value.trim())corr.push({name:ne.value.trim(),time:te?te.value.trim():'??:??'})}
    document.querySelectorAll('[id^="on_dyn_"]').forEach(function(el){if(el.value.trim()){var ti=document.getElementById(el.id.replace('on_','ot_'));corr.push({name:el.value.trim(),time:ti?ti.value.trim():'??:??'})}});
    pendPat=corr;closeM();cfm('Traiter ?',pendPat.length+' patients, '+pendSpo.length+' sportifs',doProcess)}}
window.ocrAdd=function(){var list=document.getElementById('ocrPL');if(!list)return;dynIdx++;var div=document.createElement('div');div.className='ocr-item';div.innerHTML='<span class="ocr-time"><input value="??:??" id="ot_dyn_'+dynIdx+'"></span><input placeholder="NOM Pr\u00e9nom" id="on_dyn_'+dynIdx+'"><button class="ocr-del" onclick="this.closest(\'.ocr-item\').remove()">\u2715</button>';list.appendChild(div)}

function doProcess(){
  var t=td();
  for(var i=0;i<pendPat.length;i++){var p=pendPat[i];if(!p||!p.name)continue;var id=pid(p.name);
    if(!DB.patients[id])DB.patients[id]={name:p.name,time:p.time,group:'jourj',sessions:[],billings:[],special:[]};
    else DB.patients[id].time=p.time;
    if(!DB.patients[id].special)DB.patients[id].special=[];
    var pd=pDate(DB.patients[id].group);if(DB.patients[id].sessions.indexOf(pd)<0)DB.patients[id].sessions.push(pd);DB.patients[id].sessions.sort()}
  for(var j=0;j<pendSpo.length;j++){var nm=pendSpo[j],sid=pid(nm);
    if(!DB.sportifs[sid])DB.sportifs[sid]={name:nm,sessions:[],billings:[],special:[]};
    if(!DB.sportifs[sid].special)DB.sportifs[sid].special=[];
    if(DB.sportifs[sid].sessions.indexOf(t)<0)DB.sportifs[sid].sessions.push(t);DB.sportifs[sid].sessions.sort()}
  DB.lastUpload=t;sv();toast('OK','ok');
  var newP=pendPat.filter(function(p){return p&&p.name&&DB.patients[pid(p.name)]&&DB.patients[pid(p.name)].sessions.length<=1});
  if(newP.length)modalAssign(newP);else{checkAl();switchTab('groups')}pendPat=[];pendSpo=[];document.getElementById('btnGo').style.display='none'}

function modalAssign(pts){
  var h='<h3>\uD83C\uDD95 Nouveaux patients</h3><p>Assignez :</p><div style="max-height:55vh;overflow-y:auto">';
  for(var i=0;i<pts.length;i++){var id=pid(pts[i].name);h+='<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid var(--bd)"><span style="flex:1;font-size:.8rem">'+pts[i].name+'</span><span style="font-family:JetBrains Mono;font-size:.66rem;color:var(--tx2)">'+pts[i].time+'</span><select id="ga_'+id+'" style="background:var(--bg);color:var(--tx);border:1px solid var(--bd);border-radius:6px;padding:4px;font-size:.7rem"><option value="jourj">Jour J</option><option value="lendemain">J+1</option></select></div>'}
  h+='</div><div class="ma"><button class="btn btn-p btn-sm" id="gaOK">Enregistrer</button></div>';modal(h);
  document.getElementById('gaOK').onclick=function(){for(var i=0;i<pts.length;i++){var id=pid(pts[i].name),sel=document.getElementById('ga_'+id);if(sel){DB.patients[id].group=sel.value;var t=td(),tm=nxtD(t);DB.patients[id].sessions=DB.patients[id].sessions.filter(function(s){return s!==t&&s!==tm});var pd=pDate(sel.value);if(DB.patients[id].sessions.indexOf(pd)<0)DB.patients[id].sessions.push(pd);DB.patients[id].sessions.sort()}}sv();closeM();toast('OK','ok');checkAl();switchTab('groups')}}

// Alerts
function checkAl(){var c=document.getElementById('alGrp');if(!c)return;c.innerHTML='';
  var jj=Object.values(DB.patients).filter(function(p){return p.group==='jourj'&&act(p)}),ll=Object.values(DB.patients).filter(function(p){return p.group==='lendemain'&&act(p)});
  if(!jj.length&&!ll.length)return;var diff=Math.abs(jj.length-ll.length)/Math.max(jj.length,ll.length,1);
  if(diff>.2){var bg=jj.length>ll.length?'jourj':'lendemain';c.innerHTML+='<div class="al al-w">\u26A0\uFE0F D\u00e9s\u00e9quilibre '+Math.round(diff*100)+'% : '+jj.length+' J vs '+ll.length+' J+1 <button class="btn btn-sm btn-s" style="margin-left:auto" onclick="modalRebal(\''+bg+'\')">\u21C4</button></div>'}
  if(jj.length>35)c.innerHTML+='<div class="al al-d">\uD83D\uDEA8 J:'+jj.length+' (>35) <button class="btn btn-sm btn-s" style="margin-left:auto" onclick="modalRebal(\'jourj\')">\u21C4</button></div>';
  if(ll.length>35)c.innerHTML+='<div class="al al-d">\uD83D\uDEA8 J+1:'+ll.length+' (>35) <button class="btn btn-sm btn-s" style="margin-left:auto" onclick="modalRebal(\'lendemain\')">\u21C4</button></div>'}

function modalRebal(from){
  var pts=Object.entries(DB.patients).filter(function(e){return e[1].group===from&&act(e[1])}).sort(function(a,b){return a[1].name.localeCompare(b[1].name)});
  var tgt=from==='jourj'?'J+1':'Jour J',tk=from==='jourj'?'lendemain':'jourj';
  var h='<h3>Basculer \u2192 '+tgt+'</h3><div style="max-height:55vh;overflow-y:auto">';
  for(var i=0;i<pts.length;i++)h+='<div class="pi" onclick="this.querySelector(\'.ck\').classList.toggle(\'on\')"><div class="ck" data-id="'+pts[i][0]+'"></div><span class="tm">'+(pts[i][1].time||'--')+'</span><span class="nm">'+pts[i][1].name+'</span></div>';
  h+='</div><div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="rbOK">Basculer</button></div>';modal(h);
  document.getElementById('rbOK').onclick=function(){var sel=document.querySelectorAll('.ck.on');if(!sel.length){closeM();return}
    cfm('Confirmer ?',sel.length+' \u2192 '+tgt,function(){sel.forEach(function(c){var id=c.dataset.id;DB.patients[id].group=tk;var t=td(),tm=nxtD(t);DB.patients[id].sessions=DB.patients[id].sessions.filter(function(s){return s!==t&&s!==tm});var pd=pDate(tk);if(DB.patients[id].sessions.indexOf(pd)<0)DB.patients[id].sessions.push(pd);DB.patients[id].sessions.sort()});sv();toast(sel.length+' bascul\u00e9(s)','ok');checkAl();renderGrp()})}}

// Groups
function renderGrp(){checkAl();var c=document.getElementById('grpList'),sr=document.getElementById('srGrp').value.toLowerCase(),fl=document.querySelector('#tgrGrp .tgb.on');fl=fl?fl.dataset.f:'all';
  var pts=Object.entries(DB.patients).filter(function(e){return act(e[1])}).filter(function(e){return fl==='all'||e[1].group===fl}).filter(function(e){return!sr||e[1].name.toLowerCase().indexOf(sr)>=0}).sort(function(a,b){return(a[1].time||'99').localeCompare(b[1].time||'99')});
  document.getElementById('cJ').textContent=Object.values(DB.patients).filter(function(p){return p.group==='jourj'&&act(p)}).length;
  document.getElementById('cL').textContent=Object.values(DB.patients).filter(function(p){return p.group==='lendemain'&&act(p)}).length;
  if(!pts.length){c.innerHTML='<div class="ey"><div class="em">\uD83D\uDCCB</div><p>Aucun patient actif</p></div>';return}
  var h='';for(var i=0;i<pts.length;i++){var id=pts[i][0],p=pts[i][1],ssb=sessionsSinceBill(p);
    h+='<div class="pi" onclick="modalPerson(\''+id+'\',\'patient\')"><span class="tm">'+(p.time||'--')+'</span><span class="nm">'+p.name+'</span><span class="tg '+(p.group==='jourj'?'tg-j':'tg-l')+'">'+(p.group==='jourj'?'J':'J+1')+'</span><span style="font-size:.58rem;color:var(--tx2)">'+totalSessions(p).length+'s</span></div>'}c.innerHTML=h}
document.getElementById('srGrp').oninput=renderGrp;
document.querySelectorAll('#tgrGrp .tgb').forEach(function(b){b.onclick=function(){document.querySelectorAll('#tgrGrp .tgb').forEach(function(x){x.classList.remove('on')});b.classList.add('on');renderGrp()}});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALENDAR with click-to-add specials
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var calPendingAdds=[],calPendingRms=[];

function modalPerson(id,type,opts){
  opts=opts||{};
  var p=type==='patient'?DB.patients[id]:DB.sportifs[id];if(!p)return;
  var ss=totalSessions(p).length,bs=(p.billings||[]).length;
  var gt=type==='patient'?'<span class="tg '+(p.group==='jourj'?'tg-j':'tg-l')+'" style="padding:3px 10px;font-size:.7rem">'+(p.group==='jourj'?'\uD83D\uDFE2 Jour J':'\uD83D\uDD35 J+1')+'</span>':'<span class="tg tg-s" style="padding:3px 10px;font-size:.7rem">\uD83C\uDFC3 Sportif</span>';
  var h='<h3>'+p.name+'</h3><div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">'+gt+(type==='patient'?'<span style="font-family:JetBrains Mono;font-size:.7rem;color:var(--tx2)">\u23F0 '+(p.time||'--')+'</span>':'')+'</div>';
  h+='<div class="sg"><div class="sc"><div class="sv" style="font-size:1.1rem;color:var(--grn)">'+ss+'</div><div class="sl">S\u00e9ances</div></div><div class="sc"><div class="sv" style="font-size:1.1rem;color:var(--ylw)">'+bs+'</div><div class="sl">Factures</div></div></div>';
  h+='<div id="calW"></div>';
  h+='<div id="calEditBar"></div>';
  h+='<div class="lgd"><span><div class="ldot" style="background:var(--grn)"></div>Pr\u00e9sent</span><span><div class="ldot" style="background:var(--ylw)"></div>Factur\u00e9</span><span><div class="ldot" style="background:var(--pur)"></div>Sp\u00e9cial</span><span><div class="ldot" style="background:var(--blu);opacity:.35"></div>Jour peu charg\u00e9</span></div>';
  h+='<p style="font-size:.68rem;color:var(--tx3);margin-bottom:8px">\uD83D\uDC46 Cliquez sur une date pour ajouter/retirer une pr\u00e9sence sp\u00e9ciale</p>';
  h+='<div class="ma" style="flex-wrap:wrap">';
  if(type==='patient')h+='<button class="btn btn-sm btn-s" onclick="closeM();togGrp(\''+id+'\')">Changer groupe</button>';
  h+='<button class="btn btn-sm btn-d" onclick="closeM();remPerson(\''+id+'\',\''+type+'\')">Supprimer</button>';
  h+='<button class="btn btn-sm btn-s" onclick="closeM()">Fermer</button></div>';
  calPendingAdds=[];calPendingRms=[];
  modal(h);renderCal(id,type,0);
  if(opts.thenBill){
    // Add bill button at top
    var ml=document.querySelector('.ml');if(ml){var bb=document.createElement('div');bb.style.cssText='margin-bottom:12px';
      bb.innerHTML='<button class="btn btn-p btn-bk btn-sm" id="calBillBtn">\uD83D\uDCB3 Facturer '+p.name+'</button>';
      ml.insertBefore(bb,ml.children[1]);
      document.getElementById('calBillBtn').onclick=function(){closeM();doBill(id)}}}
}

function renderCal(id,type,mo){
  var p=type==='patient'?DB.patients[id]:DB.sportifs[id];if(!p)return;
  var cw=document.getElementById('calW');if(!cw)return;
  var now=new Date(),vd=new Date(now.getFullYear(),now.getMonth()+mo,1),yr=vd.getFullYear(),mn=vd.getMonth();
  var fd=(new Date(yr,mn,1).getDay()+6)%7,dim=new Date(yr,mn+1,0).getDate(),todayStr=td();
  // Daily load across all
  var dL={};for(var d=1;d<=dim;d++){var ds=yr+'-'+String(mn+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');var cnt=0;
    Object.values(DB.patients).forEach(function(x){if((x.sessions||[]).indexOf(ds)>=0||(x.special||[]).indexOf(ds)>=0)cnt++});
    Object.values(DB.sportifs).forEach(function(x){if((x.sessions||[]).indexOf(ds)>=0||(x.special||[]).indexOf(ds)>=0)cnt++});dL[ds]=cnt}
  var loads=Object.values(dL).filter(function(v){return v>0}),minL=loads.length?Math.min.apply(null,loads):0;
  var sess=p.sessions||[],bills=p.billings||[],specs=p.special||[];
  var h='<div class="cal-hdr"><button onclick="renderCal(\''+id+'\',\''+type+'\','+(mo-1)+')">\u25C0</button><span>'+MN[mn]+' '+yr+'</span><button onclick="renderCal(\''+id+'\',\''+type+'\','+(mo+1)+')"'+(mo>=0?' disabled':'')+'>\u25B6</button></div><div class="cal-grid">';
  ['L','M','M','J','V','S','D'].forEach(function(dn){h+='<div class="cal-day">'+dn+'</div>'});
  for(var i=0;i<fd;i++)h+='<div class="cal-cell other"></div>';
  for(var d=1;d<=dim;d++){var ds=yr+'-'+String(mn+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    var it=ds===todayStr,hs=sess.indexOf(ds)>=0,hb=bills.indexOf(ds)>=0,hsp=specs.indexOf(ds)>=0;
    var il=dL[ds]>0&&dL[ds]===minL;
    var isPendAdd=calPendingAdds.indexOf(ds)>=0,isPendRm=calPendingRms.indexOf(ds)>=0;
    var cls='cal-cell';if(it)cls+=' today';if(il)cls+=' low-day';
    if(isPendAdd)cls+=' pending-add';
    else if(isPendRm)cls+=' pending-rm';
    else if(hsp)cls+=' has-spec';
    var dots='';if(hs)dots+='<div class="dot" style="background:var(--grn)"></div>';if(hb)dots+='<div class="dot" style="background:var(--ylw)"></div>';if(hsp&&!isPendRm)dots+='<div class="dot" style="background:var(--pur)"></div>';if(isPendAdd)dots+='<div class="dot" style="background:var(--pur)"></div>';
    // Future dates not clickable
    var future=ds>todayStr;
    h+='<div class="'+cls+'"'+(future?'':' onclick="calToggle(\''+id+'\',\''+type+'\',\''+ds+'\','+mo+')"')+' title="'+(dL[ds]||0)+' pr\u00e9sences"><span>'+d+'</span><div class="dots">'+dots+'</div></div>'}
  h+='</div>';cw.innerHTML=h;
  // Edit bar
  var bar=document.getElementById('calEditBar');
  var total=calPendingAdds.length+calPendingRms.length;
  if(total>0&&bar){
    bar.innerHTML='<div class="cal-edit-bar"><span class="info">'+calPendingAdds.length+' ajout(s), '+calPendingRms.length+' retrait(s)</span><span class="cnt">'+total+'</span><button class="btn btn-p btn-sm" onclick="calSave(\''+id+'\',\''+type+'\','+mo+')">\u2705 Valider</button><button class="btn btn-s btn-sm" onclick="calCancel(\''+id+'\',\''+type+'\','+mo+')">\u2715</button></div>'}
  else if(bar)bar.innerHTML='';
}

window.calToggle=function(id,type,ds,mo){
  var p=type==='patient'?DB.patients[id]:DB.sportifs[id];if(!p)return;
  var specs=p.special||[];var isSpec=specs.indexOf(ds)>=0;
  var addIdx=calPendingAdds.indexOf(ds),rmIdx=calPendingRms.indexOf(ds);
  if(isSpec){// Already special: toggle removal
    if(rmIdx>=0)calPendingRms.splice(rmIdx,1);else calPendingRms.push(ds)
  }else{// Not special: toggle addition
    if(addIdx>=0)calPendingAdds.splice(addIdx,1);else calPendingAdds.push(ds)}
  renderCal(id,type,mo)};

window.calSave=function(id,type,mo){
  var p=type==='patient'?DB.patients[id]:DB.sportifs[id];if(!p)return;
  if(!p.special)p.special=[];
  for(var i=0;i<calPendingAdds.length;i++){if(p.special.indexOf(calPendingAdds[i])<0)p.special.push(calPendingAdds[i])}
  for(var j=0;j<calPendingRms.length;j++){var idx=p.special.indexOf(calPendingRms[j]);if(idx>=0)p.special.splice(idx,1)}
  p.special.sort();calPendingAdds=[];calPendingRms=[];
  sv();toast((calPendingAdds.length+calPendingRms.length)||'Calendrier'+ ' mis \u00e0 jour','ok');renderCal(id,type,mo)};

window.calCancel=function(id,type,mo){calPendingAdds=[];calPendingRms=[];renderCal(id,type,mo)};

function togGrp(id){var p=DB.patients[id],ng=p.group==='jourj'?'lendemain':'jourj',lb=ng==='jourj'?'Jour J':'J+1';cfm('Changer ?',p.name+' \u2192 '+lb,function(){DB.patients[id].group=ng;sv();toast('\u2192 '+lb,'ok');renderGrp()})}
function remPerson(id,type){var nm=(type==='patient'?DB.patients[id]:DB.sportifs[id]);nm=nm?nm.name:'?';cfm('Supprimer ?',nm,function(){if(type==='patient')delete DB.patients[id];else delete DB.sportifs[id];sv();toast('Supprim\u00e9','ok');renderGrp();renderSpo()})}
function modalAddPat(){
  modal('<h3>\u2795 Ajouter patient</h3><input class="si" id="npN" placeholder="NOM Pr\u00e9nom"><input class="si" id="npT" placeholder="Heure (10:30)"><select class="si" id="npG"><option value="jourj">Jour J</option><option value="lendemain">Lendemain</option></select><div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="apOK">Ajouter</button></div>');
  document.getElementById('apOK').onclick=function(){var n=document.getElementById('npN').value.trim(),t=document.getElementById('npT').value.trim(),g=document.getElementById('npG').value;if(!n){toast('Nom requis','err');return}cfm('Ajouter ?',n,function(){var id=pid(n);DB.patients[id]={name:n,time:t,group:g,sessions:[pDate(g)],billings:[],special:[]};sv();toast('Ajout\u00e9','ok');renderGrp()})}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BILLING (with calendar access)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function compBill(){if(!isBD())return[];var todayStr=td(),cands=[];
  Object.entries(DB.patients).forEach(function(e){var id=e[0],p=e[1];if(!act(p))return;if((p.billings||[]).indexOf(todayStr)>=0)return;
    var freq=p.group==='jourj'?DB.settings.freqJ:DB.settings.freqL;
    var sb=sessionsSinceBill(p);
    if(sb>=freq){var hour=parseInt((p.time||'99').split(':')[0])||99;var lb=p.billings&&p.billings.length?p.billings[p.billings.length-1]:null;cands.push({id:id,p:p,sb:sb,freq:freq,urg:sb/freq,lb:lb,time:p.time||'99:99',hour:hour})}});
  cands.sort(function(a,b){if(b.urg!==a.urg)return b.urg-a.urg;return(a.lb||'1970').localeCompare(b.lb||'1970')});
  var maxH=DB.settings.maxCVH||3,hS={},sel=[];
  for(var i=0;i<cands.length;i++){var h=cands[i].hour;if(!hS[h])hS[h]=0;if(hS[h]<maxH){sel.push(cands[i]);hS[h]++}}return sel}

function renderBill(){
  var c=document.getElementById('billList'),bc=document.getElementById('billedList'),todayStr=td();
  document.getElementById('billInfo').textContent='Max '+DB.settings.maxCVH+' CV/h \u00b7 J \u2248 '+DB.settings.freqJ+'s \u00b7 J+1 \u2248 '+DB.settings.freqL+'s \u00b7 Priorit\u00e9: plus anciens';
  if(!isBD()){var days=DB.settings.billDays.map(function(d){return DNF[d]}).join(', ');c.innerHTML='<div class="al al-i">\uD83D\uDCA1 Facturation : '+days+'</div>';bc.innerHTML='';return}
  var toBill=compBill(),done=Object.entries(DB.patients).filter(function(e){return(e[1].billings||[]).indexOf(todayStr)>=0}).sort(function(a,b){return(a[1].time||'').localeCompare(b[1].time||'')});
  if(!toBill.length)c.innerHTML='<div class="ey"><div class="em">\u2705</div><p>Aucun patient \u00e0 facturer</p></div>';
  else{var h='';for(var i=0;i<toBill.length;i++){var x=toBill[i];
    h+='<div class="pi" style="border-left:3px solid var(--ylw)">'
      +'<span class="tm">'+(x.p.time||'--')+'</span><span class="nm">'+x.p.name+'</span>'
      +'<span class="tg '+(x.p.group==='jourj'?'tg-j':'tg-l')+'" style="font-size:.52rem">'+(x.p.group==='jourj'?'J':'J+1')+'</span>'
      +'<span class="tg tg-f">'+x.sb+'s</span>'
      +'<button class="btn-icon" onclick="event.stopPropagation();modalPerson(\''+x.id+'\',\'patient\',{thenBill:true})" title="Calendrier">\uD83D\uDCC5</button>'
      +'<button class="btn btn-sm btn-p" onclick="doBill(\''+x.id+'\')">\uD83D\uDCB3</button></div>'}c.innerHTML=h}
  if(!done.length)bc.innerHTML='<p style="color:var(--tx2);font-size:.76rem;padding:6px">Aucun</p>';
  else{var h2='';for(var j=0;j<done.length;j++){var id=done[j][0],p=done[j][1];
    h2+='<div class="pi" style="border-left:3px solid var(--grn)">'
      +'<span class="tm">'+(p.time||'--')+'</span><span class="nm">'+p.name+'</span>'
      +'<span class="tg tg-ok">\u2713</span>'
      +'<button class="btn-icon" onclick="event.stopPropagation();modalPerson(\''+id+'\',\'patient\')" title="Calendrier">\uD83D\uDCC5</button>'
      +'<button class="btn btn-sm btn-d" onclick="unBill(\''+id+'\')">\u2715</button></div>'}bc.innerHTML=h2}}

function doBill(id){var p=DB.patients[id];cfm('Facturer ?',p.name,function(){var t=td();
  if(p.group==='lendemain'){var tm=nxtD(t);p.sessions=p.sessions.filter(function(s){return s!==tm});if(p.sessions.indexOf(t)<0)p.sessions.push(t);p.sessions.sort()}
  if(p.billings.indexOf(t)<0){p.billings.push(t);p.billings.sort()}if(!DB.dailyBills[t])DB.dailyBills[t]=0;DB.dailyBills[t]++;sv();toast(p.name+' \u2713','ok');renderBill();renderDash()})}

function unBill(id){var p=DB.patients[id];cfm('Annuler ?',p.name,function(){var t=td();p.billings=p.billings.filter(function(b){return b!==t});
  if(p.group==='lendemain'){p.sessions=p.sessions.filter(function(s){return s!==t});var tm=nxtD(t);if(p.sessions.indexOf(tm)<0)p.sessions.push(tm);p.sessions.sort()}
  if(DB.dailyBills[t])DB.dailyBills[t]--;sv();toast('Annul\u00e9','ok');renderBill();renderDash()})}

// Sportifs
function renderSpo(){
  var c=document.getElementById('spoList'),bc=document.getElementById('spoBill'),todayStr=td();
  var ac=Object.entries(DB.sportifs).filter(function(e){var l=e[1].sessions&&e[1].sessions.length?e[1].sessions[e[1].sessions.length-1]:null;return l&&(new Date(todayStr)-new Date(l))/864e5<14}).sort(function(a,b){return a[1].name.localeCompare(b[1].name)});
  if(!ac.length){c.innerHTML='<div class="ey"><div class="em">\uD83C\uDFC3</div><p>Aucun sportif actif</p></div>';bc.innerHTML='';return}
  var h='';for(var i=0;i<ac.length;i++){var id=ac[i][0],s=ac[i][1],pr=(s.sessions||[]).indexOf(todayStr)>=0;
    h+='<div class="pi" onclick="modalPerson(\''+id+'\',\'sportif\')"><span class="nm">'+s.name+'</span><span class="tg tg-s">SPORT</span>'+(pr?'<span style="font-size:.66rem;color:var(--grn)">\u2713</span>':'')+'</div>'}c.innerHTML=h;
  var toBill=Object.entries(DB.sportifs).filter(function(e){return(e[1].sessions||[]).indexOf(todayStr)>=0&&(e[1].billings||[]).indexOf(todayStr)<0});
  if(!toBill.length){bc.innerHTML='<p style="color:var(--tx2);font-size:.76rem;padding:6px">Aucun sportif \u00e0 facturer</p>';return}
  toBill.sort(function(a,b){var la=a[1].billings&&a[1].billings.length?a[1].billings[a[1].billings.length-1]:'1970';var lb_=b[1].billings&&b[1].billings.length?b[1].billings[b[1].billings.length-1]:'1970';return la.localeCompare(lb_)});
  var sid=toBill[0][0],sp=toBill[0][1];
  var wp=[],ss=sp.sessions||[];for(var j=0;j<ss.length;j++){var d=new Date(ss[j]);if(d.getDay()===1){var thu=new Date(d);thu.setDate(thu.getDate()+3);var ts=thu.toISOString().slice(0,10);if(ss.indexOf(ts)>=0)wp.push({mon:ss[j],thu:ts})}}
  var wpI='';if(wp.length){var lp=wp[wp.length-1],mc=dbcF(lp.mon),tc=dbcF(lp.thu),best=mc<=tc?'Lundi':'Jeudi';wpI='<div class="al al-i" style="margin-top:8px">\uD83D\uDCCA Sem. '+new Date(lp.mon).toLocaleDateString('fr-FR')+' : '+best+' moins factur\u00e9 ('+Math.min(mc,tc)+' vs '+Math.max(mc,tc)+')</div>'}
  bc.innerHTML='<div class="pi" style="border-left:3px solid var(--org)"><span class="nm">'+sp.name+'</span><span class="tg tg-y">CV</span><button class="btn-icon" onclick="event.stopPropagation();modalPerson(\''+sid+'\',\'sportif\')">\uD83D\uDCC5</button><button class="btn btn-sm btn-p" onclick="billSpo(\''+sid+'\')">\uD83D\uDCB3</button></div>'+wpI}

function dbcF(ds){var c=DB.dailyBills[ds]||0;Object.values(DB.sportifs).forEach(function(s){if((s.billings||[]).indexOf(ds)>=0)c++});return c}
function billSpo(id){var s=DB.sportifs[id];cfm('Carte vitale ?',s.name,function(){var t=td();if(!s.billings)s.billings=[];if(s.billings.indexOf(t)<0){s.billings.push(t);s.billings.sort()}if(!DB.dailyBills[t])DB.dailyBills[t]=0;DB.dailyBills[t]++;sv();toast(s.name+' CV \u2713','ok');renderSpo();renderDash()})}

// History
function renderHist(){var c=document.getElementById('histList'),sr=document.getElementById('srHist').value.toLowerCase(),h='';
  var pts=Object.entries(DB.patients).filter(function(e){return!sr||e[1].name.toLowerCase().indexOf(sr)>=0}).sort(function(a,b){return a[1].name.localeCompare(b[1].name)});
  if(pts.length){h+='<div class="sh"><h3>Patients</h3><span style="font-size:.7rem;color:var(--tx2)">'+pts.length+'</span></div>';
    for(var i=0;i<pts.length;i++){var id=pts[i][0],p=pts[i][1];h+='<div class="pi" onclick="modalPerson(\''+id+'\',\'patient\')"><span class="nm">'+p.name+'</span><span class="tg '+(p.group==='jourj'?'tg-j':'tg-l')+'" style="font-size:.52rem">'+(p.group==='jourj'?'J':'J+1')+'</span><span style="font-size:.58rem;color:var(--tx2)">'+totalSessions(p).length+'s/'+(p.billings||[]).length+'f</span></div>'}}
  var sps=Object.entries(DB.sportifs).filter(function(e){return!sr||e[1].name.toLowerCase().indexOf(sr)>=0}).sort(function(a,b){return a[1].name.localeCompare(b[1].name)});
  if(sps.length){h+='<div class="sh" style="margin-top:14px"><h3>Sportifs</h3><span style="font-size:.7rem;color:var(--tx2)">'+sps.length+'</span></div>';
    for(var j=0;j<sps.length;j++){var sid=sps[j][0],s=sps[j][1];h+='<div class="pi" onclick="modalPerson(\''+sid+'\',\'sportif\')"><span class="nm">'+s.name+'</span><span class="tg tg-s" style="font-size:.52rem">SPORT</span><span style="font-size:.58rem;color:var(--tx2)">'+totalSessions(s).length+'p/'+(s.billings||[]).length+'f</span></div>'}}
  if(!h)h='<div class="ey"><div class="em">\uD83D\uDCC5</div><p>Aucun historique</p></div>';c.innerHTML=h}
document.getElementById('srHist').oninput=renderHist;

// Dashboard
function renderDash(){
  var todayStr=td(),hr=new Date().getHours();
  document.getElementById('dashGreet').textContent=(hr<12?'Bonjour':hr<18?'Bon apr\u00e8s-midi':'Bonsoir')+' \uD83D\uDC4B';
  document.getElementById('dashDate').textContent=tdFr();
  var aPat=Object.values(DB.patients).filter(act),aSpo=Object.values(DB.sportifs).filter(function(s){var l=s.sessions&&s.sessions.length?s.sessions[s.sessions.length-1]:null;return l&&(new Date(todayStr)-new Date(l))/864e5<14});
  var bToday=Object.values(DB.patients).filter(function(p){return(p.billings||[]).indexOf(todayStr)>=0}).length;
  var toBill=isBD()?compBill().length:0;
  document.getElementById('dashStats').innerHTML='<div class="sc"><div class="sv" style="font-size:1.2rem;color:var(--grn)">'+aPat.length+'</div><div class="sl">Patients</div></div><div class="sc"><div class="sv" style="font-size:1.2rem;color:var(--org)">'+aSpo.length+'</div><div class="sl">Sportifs</div></div><div class="sc"><div class="sv" style="font-size:1.2rem;color:var(--ylw)">'+toBill+'</div><div class="sl">\u00c0 facturer</div></div><div class="sc"><div class="sv" style="font-size:1.2rem;color:var(--blu)">'+bToday+'</div><div class="sl">Factur\u00e9s</div></div>';
  var al=document.getElementById('dashAlerts');al.innerHTML='';
  if(isBD()&&DB.lastUpload!==todayStr)al.innerHTML='<div class="al al-w">\uD83D\uDCF7 Importez vos captures du jour !</div>';
  if(toBill>0)al.innerHTML+='<div class="al al-i">\uD83D\uDCB3 '+toBill+' patient(s) \u00e0 facturer</div>';
  var tb=document.getElementById('dashToBill');
  if(isBD()&&toBill){var list=compBill().slice(0,4),h2='<h3>\uD83D\uDCB3 \u00c0 facturer</h3>';
    for(var i=0;i<list.length;i++)h2+='<div class="pi" onclick="switchTab(\'billing\')"><span class="tm">'+(list[i].p.time||'--')+'</span><span class="nm">'+list[i].p.name+'</span><span class="tg tg-f">'+list[i].sb+'s</span></div>';
    if(toBill>4)h2+='<p style="font-size:.72rem;color:var(--tx2);margin-top:6px">+'+(toBill-4)+' autre(s)</p>';tb.innerHTML=h2}else tb.innerHTML='';
  var ds=document.getElementById('dashSport');
  var sB=Object.entries(DB.sportifs).filter(function(e){return(e[1].sessions||[]).indexOf(todayStr)>=0&&(e[1].billings||[]).indexOf(todayStr)<0});
  if(sB.length){sB.sort(function(a,b){var la=a[1].billings&&a[1].billings.length?a[1].billings[a[1].billings.length-1]:'1970';var lb_=b[1].billings&&b[1].billings.length?b[1].billings[b[1].billings.length-1]:'1970';return la.localeCompare(lb_)});
    ds.innerHTML='<h3>\uD83C\uDFC3 Sportif CV</h3><div class="pi" onclick="switchTab(\'sports\')"><span class="nm">'+sB[0][1].name+'</span><span class="tg tg-y">CV</span></div>'}else ds.innerHTML=''}

// Settings
function renderSettings(){var dc=document.getElementById('billDays');dc.innerHTML='';
  for(var i=0;i<7;i++){var chip=document.createElement('span');chip.className='day-chip'+(DB.settings.billDays.indexOf(i)>=0?' on':'');chip.textContent=DN[i];chip.dataset.d=String(i);chip.onclick=function(){this.classList.toggle('on')};dc.appendChild(chip)}
  document.getElementById('freqJ').value=DB.settings.freqJ;document.getElementById('freqL').value=DB.settings.freqL;document.getElementById('maxCVH').value=DB.settings.maxCVH}
function saveSettings(){var days=[];document.querySelectorAll('.day-chip.on').forEach(function(c){days.push(parseInt(c.dataset.d))});if(!days.length){toast('Min 1 jour','err');return}
  cfm('Enregistrer ?','Sauvegarder ?',function(){DB.settings.billDays=days;DB.settings.freqJ=parseInt(document.getElementById('freqJ').value)||3;DB.settings.freqL=parseInt(document.getElementById('freqL').value)||5;DB.settings.maxCVH=parseInt(document.getElementById('maxCVH').value)||3;sv();toast('OK','ok')})}
function exportCSV(){var csv='Type,Nom,Groupe,S\u00e9ances,Sp\u00e9ciales,Factures\n';
  Object.values(DB.patients).forEach(function(p){csv+='Patient,"'+p.name+'",'+p.group+','+(p.sessions||[]).length+','+(p.special||[]).length+','+(p.billings||[]).length+'\n'});
  Object.values(DB.sportifs).forEach(function(s){csv+='Sportif,"'+s.name+'",-,'+(s.sessions||[]).length+','+(s.special||[]).length+','+(s.billings||[]).length+'\n'});
  dlFile(csv,'kineplan.csv','text/csv');toast('CSV','ok')}
function exportJSON(){dlFile(JSON.stringify(DB,null,2),'kineplan.json','application/json');toast('JSON','ok')}
function dlFile(c,n,t){var b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=n;a.click();URL.revokeObjectURL(u)}
function confirmClear(){cfm('\u26A0\uFE0F Tout effacer ?','Suppression d\u00e9finitive.',function(){localStorage.removeItem(SK);DB=ld();for(var i=0;i<MASTERS.length;i++){var id=pid(MASTERS[i]);DB.sportifs[id]={name:MASTERS[i],sessions:[],billings:[],special:[]}}sv();toast('Effac\u00e9','ok');switchTab('dash')})}

if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(function(){});
renderDash();
</script>
</body>
</html>
