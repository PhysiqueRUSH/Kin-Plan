<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b1120">
<link rel="manifest" href="manifest.json">
<title>KinÃ©Plan</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0b1120;--bg2:#111827;--bg3:#1a2540;--card:#151f35;
  --bdr:#1e2d4a;--bdr2:#2a3f66;
  --tx:#e2e8f0;--tx2:#7a8baa;--tx3:#4a5a78;
  --grn:#00d4aa;--grn2:#00b490;--grnd:rgba(0,212,170,.12);
  --blu:#38a3ff;--blud:rgba(56,163,255,.12);
  --org:#ff9f43;--orgd:rgba(255,159,67,.12);
  --red:#ff5274;--redd:rgba(255,82,116,.12);
  --ylw:#f0c040;--ylwd:rgba(240,192,64,.12);
  --pur:#a78bfa;--purd:rgba(167,139,250,.12);
  --r:10px;--r2:14px;
  --sh:0 4px 20px rgba(0,0,0,.35);
}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;overscroll-behavior:none;-webkit-tap-highlight-color:transparent}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-thumb{background:var(--bdr);border-radius:3px}
input,select,textarea,button{font-family:inherit}

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.top{position:sticky;top:0;z-index:100;background:var(--bg);border-bottom:1px solid var(--bdr);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.top h1{font-family:'JetBrains Mono',monospace;font-size:1.15rem;background:linear-gradient(135deg,var(--grn),var(--blu));-webkit-background-clip:text;-webkit-text-fill-color:transparent;letter-spacing:-.5px}
.top-sub{font-family:'JetBrains Mono',monospace;font-size:.7rem;color:var(--tx2)}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;background:var(--bg2);border-bottom:1px solid var(--bdr);overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:none;padding:11px 14px;font-size:.7rem;font-weight:600;color:var(--tx2);background:0;border:0;cursor:pointer;position:relative;white-space:nowrap;transition:.15s}
.tab.on{color:var(--grn)}.tab.on::after{content:'';position:absolute;bottom:0;left:15%;right:15%;height:2px;background:var(--grn);border-radius:2px}
.tab .bdg{display:inline-block;background:var(--red);color:#fff;font-size:.55rem;padding:1px 5px;border-radius:7px;margin-left:3px;vertical-align:middle}

/* â”€â”€â”€ PANELS â”€â”€â”€ */
.pnl{display:none;padding:14px 14px 120px}.pnl.on{display:block;animation:fi .2s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* â”€â”€â”€ CARD â”€â”€â”€ */
.cd{background:var(--card);border:1px solid var(--bdr);border-radius:var(--r2);padding:14px;margin-bottom:11px;box-shadow:var(--sh)}
.cd-t{font-family:'JetBrains Mono',monospace;font-size:.8rem;color:var(--grn);margin-bottom:10px;display:flex;align-items:center;gap:7px}
.cd-t .ic{font-size:1rem}

/* â”€â”€â”€ UPLOAD â”€â”€â”€ */
.uz{border:2px dashed var(--bdr);border-radius:var(--r2);padding:22px 16px;text-align:center;cursor:pointer;transition:.2s;background:var(--bg2);position:relative}
.uz:hover,.uz.dg{border-color:var(--grn);background:var(--grnd)}
.uz input{display:none}.uz .ui{font-size:1.8rem;margin-bottom:6px}
.uz p{font-size:.82rem;color:var(--tx2)}.uz .sub{font-size:.68rem;color:var(--tx3);margin-top:3px}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.pb{height:3px;background:var(--bg3);border-radius:3px;overflow:hidden;margin:10px 0}
.pf{height:100%;background:linear-gradient(90deg,var(--grn),var(--blu));border-radius:3px;transition:width .3s;width:0}

/* â”€â”€â”€ PATIENT ITEM â”€â”€â”€ */
.pi{display:flex;align-items:center;padding:9px 10px;border-radius:8px;margin-bottom:3px;background:var(--bg2);border:1px solid transparent;transition:.12s;gap:8px;cursor:pointer}
.pi:hover{border-color:var(--bdr)}.pi.sel{border-color:var(--grn);background:var(--grnd)}
.pi .tm{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--tx2);min-width:40px}
.pi .nm{flex:1;font-size:.84rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tg{font-size:.6rem;font-weight:700;padding:2px 7px;border-radius:5px;letter-spacing:.3px;white-space:nowrap}
.tg-j{background:var(--grnd);color:var(--grn)}.tg-l{background:var(--blud);color:var(--blu)}.tg-s{background:var(--orgd);color:var(--org)}
.tg-f{background:var(--redd);color:var(--red)}.tg-ok{background:var(--grnd);color:var(--grn)}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:9px 16px;border:0;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;transition:.12s;font-family:inherit}
.btn-p{background:linear-gradient(135deg,var(--grn),var(--grn2));color:var(--bg)}.btn-p:hover{filter:brightness(1.1)}
.btn-s{background:var(--bg3);color:var(--tx);border:1px solid var(--bdr)}.btn-d{background:var(--redd);color:var(--red);border:1px solid rgba(255,82,116,.2)}
.btn-sm{padding:6px 10px;font-size:.72rem}.btn-bk{width:100%}

/* â”€â”€â”€ ALERT â”€â”€â”€ */
.al{padding:11px 14px;border-radius:var(--r);margin-bottom:10px;font-size:.78rem;display:flex;align-items:flex-start;gap:8px;animation:si .25s ease}
@keyframes si{from{opacity:0;transform:translateX(-8px)}}
.al-w{background:var(--ylwd);border:1px solid rgba(240,192,64,.3);color:var(--ylw)}
.al-d{background:var(--redd);border:1px solid rgba(255,82,116,.3);color:var(--red)}
.al-i{background:var(--blud);border:1px solid rgba(56,163,255,.3);color:var(--blu)}
.al-g{background:var(--grnd);border:1px solid rgba(0,212,170,.3);color:var(--grn)}

/* â”€â”€â”€ MODAL â”€â”€â”€ */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);z-index:200;display:flex;align-items:center;justify-content:center;padding:14px;animation:fi .12s ease}
.ml{background:var(--bg2);border:1px solid var(--bdr);border-radius:16px;padding:20px;max-width:460px;width:100%;max-height:88vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.ml h3{font-family:'JetBrains Mono',monospace;font-size:.95rem;margin-bottom:14px;color:var(--grn)}
.ml p{font-size:.82rem;color:var(--tx2);margin-bottom:10px}
.ma{display:flex;gap:7px;margin-top:14px;justify-content:flex-end;flex-wrap:wrap}

/* â”€â”€â”€ INPUTS â”€â”€â”€ */
.si{width:100%;padding:9px 12px;background:var(--bg);border:1px solid var(--bdr);border-radius:8px;color:var(--tx);font-size:.82rem;outline:0;margin-bottom:10px}
.si:focus{border-color:var(--grn)}.si::placeholder{color:var(--tx3)}

/* â”€â”€â”€ STATS â”€â”€â”€ */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.sc{background:var(--bg2);border:1px solid var(--bdr);border-radius:10px;padding:12px;text-align:center}
.sv{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700}
.sl{font-size:.68rem;color:var(--tx2);margin-top:3px}

/* â”€â”€â”€ TOGGLE â”€â”€â”€ */
.tgr{display:flex;gap:3px;background:var(--bg);border-radius:8px;padding:3px;margin-bottom:10px}
.tgb{flex:1;padding:7px;border:0;border-radius:6px;font-size:.72rem;font-weight:600;cursor:pointer;background:0;color:var(--tx2);transition:.12s}
.tgb.on{background:var(--card);color:var(--tx);box-shadow:0 2px 8px rgba(0,0,0,.2)}

/* â”€â”€â”€ CHECKBOX â”€â”€â”€ */
.ck{width:20px;height:20px;border-radius:5px;border:2px solid var(--bdr);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.12s;flex-shrink:0}
.ck.on{background:var(--grn);border-color:var(--grn)}.ck.on::after{content:'âœ“';color:var(--bg);font-size:.7rem;font-weight:700}

/* â”€â”€â”€ SECTION HEAD â”€â”€â”€ */
.sh{display:flex;justify-content:space-between;align-items:center;margin:14px 0 6px}
.sh h3{font-size:.75rem;font-weight:600;color:var(--tx2);text-transform:uppercase;letter-spacing:.8px}

/* â”€â”€â”€ THUMBS â”€â”€â”€ */
.thr{display:flex;gap:6px;overflow-x:auto;padding:6px 0}
.th{width:50px;height:66px;border-radius:5px;object-fit:cover;border:2px solid var(--bdr);flex-shrink:0}
.th.proc{opacity:.4;animation:pls 1s infinite}@keyframes pls{50%{opacity:.2}}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toc{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:300;display:flex;flex-direction:column;gap:6px;pointer-events:none}
.to{background:var(--card);border:1px solid var(--bdr);padding:9px 16px;border-radius:10px;font-size:.78rem;box-shadow:0 8px 30px rgba(0,0,0,.45);animation:ti .25s ease,tout .25s ease 2.7s forwards;pointer-events:auto;white-space:nowrap}
@keyframes ti{from{opacity:0;transform:translateY(-16px)}}@keyframes tout{to{opacity:0;transform:translateY(-16px)}}

/* â”€â”€â”€ CALENDAR â”€â”€â”€ */
.cal{user-select:none}
.cal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.cal-hdr span{font-family:'JetBrains Mono',monospace;font-size:.85rem;font-weight:600}
.cal-hdr button{background:var(--bg3);border:1px solid var(--bdr);color:var(--tx);width:30px;height:30px;border-radius:6px;cursor:pointer;font-size:.8rem;display:flex;align-items:center;justify-content:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day{font-size:.6rem;text-align:center;color:var(--tx3);padding:4px 0;font-weight:600}
.cal-cell{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:6px;font-size:.7rem;cursor:pointer;position:relative;transition:.12s;border:1px solid transparent}
.cal-cell:hover{border-color:var(--bdr)}
.cal-cell.today{border-color:var(--grn);background:var(--grnd)}
.cal-cell.other{opacity:.3}
.cal-cell .dots{display:flex;gap:2px;margin-top:2px}
.cal-cell .dot{width:4px;height:4px;border-radius:50%}
.cal-cell.low-day{background:rgba(56,163,255,.06)}
.cal-cell.special-day{border-color:var(--pur);background:var(--purd)}

/* â”€â”€â”€ LEGEND â”€â”€â”€ */
.lgd{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;font-size:.68rem;color:var(--tx2)}
.lgd span{display:flex;align-items:center;gap:4px}
.lgd .ldot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* â”€â”€â”€ EMPTY â”€â”€â”€ */
.ey{text-align:center;padding:36px 18px;color:var(--tx2)}
.ey .em{font-size:2.2rem;margin-bottom:10px}.ey p{font-size:.82rem}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(min-width:560px){.pnl{max-width:520px;margin:0 auto}}
</style>
</head>
<body>

<div class="top"><h1>KinÃ©Plan</h1><span class="top-sub" id="topDate"></span></div>
<div class="tabs" id="tabBar">
  <button class="tab on" data-t="upload">ğŸ“· Upload</button>
  <button class="tab" data-t="groups">ğŸ‘¥ Groupes</button>
  <button class="tab" data-t="billing">ğŸ’³ Facturer</button>
  <button class="tab" data-t="sports">ğŸƒ Sportifs</button>
  <button class="tab" data-t="history">ğŸ“… Calendrier</button>
</div>

<div class="toc" id="toasts"></div>

<!-- â•â•â•â•â•â•â• UPLOAD â•â•â•â•â•â•â• -->
<div class="pnl on" id="p-upload">
  <div class="cd">
    <div class="cd-t"><span class="ic">ğŸ“·</span>Captures Patients (Doctolib)</div>
    <div class="uz" id="uzPat"><input type="file" accept="image/*" multiple id="fPat"><div class="ui">ğŸ“±</div><p>Importer captures Doctolib</p><div class="sub">Jusqu'Ã  5 captures â€¢ JPG/PNG</div></div>
    <div class="thr" id="thPat"></div>
    <div class="pb" id="pbPat" style="display:none"><div class="pf" id="pfPat"></div></div>
    <div id="stPat" style="font-size:.72rem;color:var(--tx2);margin-top:6px"></div>
  </div>
  <div class="cd">
    <div class="cd-t"><span class="ic">ğŸƒ</span>Captures Sportifs (WhatsApp)</div>
    <div class="uz" id="uzSpo"><input type="file" accept="image/*" multiple id="fSpo"><div class="ui">ğŸ’¬</div><p>Importer captures WhatsApp</p><div class="sub">Jusqu'Ã  2 captures â€¢ JPG/PNG</div></div>
    <div class="thr" id="thSpo"></div>
    <div class="pb" id="pbSpo" style="display:none"><div class="pf" id="pfSpo"></div></div>
    <div id="stSpo" style="font-size:.72rem;color:var(--tx2);margin-top:6px"></div>
  </div>
  <button class="btn btn-p btn-bk" id="btnGo" style="display:none">âœ… Valider et RÃ©partir</button>
</div>

<!-- â•â•â•â•â•â•â• GROUPS â•â•â•â•â•â•â• -->
<div class="pnl" id="p-groups">
  <div id="alGrp"></div>
  <div class="sg">
    <div class="sc"><div class="sv" style="color:var(--grn)" id="cJ">0</div><div class="sl">Jour J</div></div>
    <div class="sc"><div class="sv" style="color:var(--blu)" id="cL">0</div><div class="sl">Lendemain</div></div>
  </div>
  <input class="si" placeholder="ğŸ” Rechercher un patient..." id="srGrp">
  <div class="tgr">
    <button class="tgb on" data-f="all">Tous</button>
    <button class="tgb" data-f="jourj">Jour J</button>
    <button class="tgb" data-f="lendemain">J+1</button>
  </div>
  <div id="grpList"></div>
  <button class="btn btn-s btn-bk" style="margin-top:10px" onclick="modalAddPatient()">â• Ajouter patient</button>
</div>

<!-- â•â•â•â•â•â•â• BILLING â•â•â•â•â•â•â• -->
<div class="pnl" id="p-billing">
  <div class="cd"><div class="cd-t"><span class="ic">ğŸ’³</span>Ã€ facturer aujourd'hui</div>
    <p style="font-size:.74rem;color:var(--tx2);margin-bottom:10px">Max 3 CV/heure â€¢ Jour J â‰ˆ 3 sÃ©ances â€¢ Lendemain â‰ˆ 5 sÃ©ances â€¢ PrioritÃ© : plus anciennement facturÃ©s</p>
    <div id="billList"></div>
  </div>
  <div class="cd"><div class="cd-t"><span class="ic">âœ…</span>DÃ©jÃ  facturÃ©s aujourd'hui</div><div id="billedList"></div></div>
</div>

<!-- â•â•â•â•â•â•â• SPORTS â•â•â•â•â•â•â• -->
<div class="pnl" id="p-sports">
  <div class="cd"><div class="cd-t"><span class="ic">ğŸƒ</span>Sportifs du jour</div><div id="spoList"></div></div>
  <div class="cd"><div class="cd-t"><span class="ic">ğŸ’³</span>Carte Vitale Sportif</div><div id="spoBill"></div></div>
</div>

<!-- â•â•â•â•â•â•â• CALENDAR / HISTORY â•â•â•â•â•â•â• -->
<div class="pnl" id="p-history">
  <input class="si" placeholder="ğŸ” Rechercher patient/sportif..." id="srHist">
  <div id="histList"></div>
</div>

<div id="moCont"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SK='kineplan2';
const SPORTIFS_MASTER=[
  'ARNALDI Bastien','BREMOND Mathieu','CHALMET Anne-Dominique','COQUILLARD Damien',
  'COQUILLARD Leslie','COUVREUX Jonathan','DJEFFEL Christophe','FIENGO Magali',
  'GIUGIARO MylÃ¨ne','GOGLIA Olivier','GOUVRY Philippe','GUERIN Emma',
  'MARCHAND Philippe','REMY Thibault','ROGER Jean-Baptiste','ROSTE Elsa'
];

function load(){try{const d=JSON.parse(localStorage.getItem(SK));if(d&&d.patients)return d}catch(e){}return{patients:{},sportifs:{},dailyBills:{},settings:{},lastUpload:null}}
function save(){localStorage.setItem(SK,JSON.stringify(DB))}
let DB=load();

// Init master sportifs
if(!Object.keys(DB.sportifs).length){
  for(const n of SPORTIFS_MASTER){
    const id=pid(n);
    if(!DB.sportifs[id])DB.sportifs[id]={name:n,sessions:[],billings:[],special:[]};
  }
  save();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function td(){return new Date().toISOString().slice(0,10)}
function tdFr(){const d=new Date(),ds=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'],ms=['janv','fÃ©vr','mars','avr','mai','juin','juil','aoÃ»t','sept','oct','nov','dÃ©c'];return`${ds[d.getDay()]} ${d.getDate()} ${ms[d.getMonth()]} ${d.getFullYear()}`}
function dow(){return new Date().getDay()}
function isUD(){const d=dow();return d===1||d===4}
function nextDay(s){const d=new Date(s);d.setDate(d.getDate()+1);return d.toISOString().slice(0,10)}
function presDate(g){return g==='jourj'?td():nextDay(td())}
function pid(n){return n.trim().toUpperCase().replace(/\s+/g,'_')}
function active(p){if(!p.sessions||!p.sessions.length)return false;const l=p.sessions[p.sessions.length-1];return(new Date(td())-new Date(l))/864e5<14}

function toast(m,t=''){const e=document.createElement('div');e.className='to';if(t==='ok')e.style.borderColor='var(--grn)';else if(t==='err')e.style.borderColor='var(--red)';e.textContent=m;document.getElementById('toasts').appendChild(e);setTimeout(()=>e.remove(),3000)}

function modal(h){document.getElementById('moCont').innerHTML=`<div class="mo" onclick="if(event.target===this)closeM()"><div class="ml">${h}</div></div>`}
function closeM(){document.getElementById('moCont').innerHTML=''}
function confirm_(t,m,fn){modal(`<h3>${t}</h3><p>${m}</p><div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="mcb">Confirmer</button></div>`);document.getElementById('mcb').onclick=()=>{closeM();fn()}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('topDate').textContent=tdFr();
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.pnl').forEach(x=>x.classList.remove('on'));
  t.classList.add('on');
  document.getElementById('p-'+t.dataset.t).classList.add('on');
  if(t.dataset.t==='groups')renderGrp();if(t.dataset.t==='billing')renderBill();
  if(t.dataset.t==='sports')renderSpo();if(t.dataset.t==='history')renderHist();
});
function switchTab(n){document.querySelectorAll('.tab').forEach(t=>{t.classList.toggle('on',t.dataset.t===n)});document.querySelectorAll('.pnl').forEach(p=>{p.classList.toggle('on',p.id==='p-'+n)});if(n==='groups')renderGrp();if(n==='billing')renderBill();if(n==='sports')renderSpo();if(n==='history')renderHist()}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OCR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ocrW=null;
async function initOCR(){if(ocrW)return ocrW;ocrW=await Tesseract.createWorker('fra');return ocrW}

function parseDoctolib(txt){
  const pts=[];const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean);
  const skip=/^(Agenda|TÃ¢ches|Messagerie|Connect|Lundi|Mardi|Mercredi|Jeudi|Vendredi|Samedi|Dimanche|Absence)/i;
  let currentTime='';
  for(let i=0;i<lines.length;i++){
    const l=lines[i];
    if(skip.test(l))continue;
    // Time line like "10:05" or "10:05\n10:40"
    const tm=l.match(/^(\d{1,2})[:\.](\d{2})$/);
    if(tm){currentTime=tm[1].padStart(2,'0')+':'+tm[2];continue}
    // Time range on same line "10:05\n10:40" (already split)
    const tmr=l.match(/^(\d{1,2})[:\.](\d{2})\s*[-â€“]?\s*$/);
    if(tmr){currentTime=tmr[1].padStart(2,'0')+':'+tmr[2];continue}
    // Name pattern: UPPERCASE words + Capitalized first name
    const nm=l.match(/^([A-ZÃ€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã™Ã›ÃœÅ¸Ã‡Å’Ã†][A-ZÃ€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã™Ã›ÃœÅ¸Ã‡Å’Ã†\s\-']{1,})\s+([A-ZÃ€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã™Ã›ÃœÅ¸Ã‡Å’Ã†a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦][a-zÃ Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã¿Ã§Å“Ã¦A-Z\-']*)/);
    if(nm){
      const full=nm[1].trim()+' '+nm[2].trim();
      if(!full.match(/^(Lundi|Mardi|Mercredi|Jeudi|Vendredi)/i)){
        pts.push({name:full,time:currentTime||'??:??'});
      }
    }
    // Also try inline time+name: "10:05 DUPONT Marie"
    const inl=l.match(/^(\d{1,2})[:\.](\d{2})\s+([A-ZÃ€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã™Ã›ÃœÅ¸Ã‡Å’Ã†][A-ZÃ€Ã‚Ã„Ã‰ÃˆÃŠÃ‹ÃÃÃ”Ã™Ã›ÃœÅ¸Ã‡Å’Ã†\s\-']+\s+[A-Za-zÃ€-Ã¿\-']+)/);
    if(inl){
      pts.push({name:inl[3].trim(),time:inl[1].padStart(2,'0')+':'+inl[2]});
    }
  }
  // Dedup
  const seen=new Set();return pts.filter(p=>{const k=pid(p.name);if(seen.has(k))return false;seen.add(k);return true});
}

// â”€â”€â”€ SMART MATCH FOR WHATSAPP NAMES â”€â”€â”€
function matchSportif(rawName){
  const rn=rawName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  let best=null,bestScore=0;
  for(const master of SPORTIFS_MASTER){
    const mn=master.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const parts=mn.split(/\s+/);
    const firstName=parts[parts.length-1];
    const lastName=parts.slice(0,-1).join(' ');
    let score=0;
    // Exact match
    if(rn===mn){score=100}
    // First name match
    else if(rn.includes(firstName)){score+=40}
    // Last name match
    else if(rn.includes(lastName)||lastName.includes(rn.split(/\s+/)[0])){score+=40}
    // Partial last name
    if(rn.split(/\s+/).some(w=>lastName.startsWith(w)&&w.length>2))score+=25;
    if(rn.split(/\s+/).some(w=>firstName.startsWith(w)&&w.length>2))score+=25;
    // Handle "Damien Sport" -> match COQUILLARD Damien
    const rnParts=rn.split(/\s+/).filter(w=>w!=='sport'&&w!=='sports');
    for(const rp of rnParts){
      if(firstName.startsWith(rp)&&rp.length>2)score+=35;
      if(lastName.startsWith(rp)&&rp.length>2)score+=30;
    }
    // "Anne-Do" -> "Anne-Dominique"
    if(parts.some(p=>p.startsWith(rn.replace(/-/g,'').slice(0,5))&&rn.length>3))score+=35;
    // "Olivier G" -> GOGLIA Olivier
    if(rnParts.length>=2){
      const last=rnParts[rnParts.length-1];
      if(last.length===1&&lastName.startsWith(last))score+=30;
      if(rnParts[0].length>2&&firstName.startsWith(rnParts[0]))score+=30;
    }
    // "BASTIEN" alone -> ARNALDI Bastien
    if(rnParts.length===1&&rnParts[0].length>3){
      if(firstName===rnParts[0])score+=50;
      if(lastName===rnParts[0])score+=45;
    }
    // "Emma SPORT" -> GUERIN Emma, "Magali SPORT" -> FIENGO Magali
    if(rnParts.some(w=>w===firstName))score+=40;
    
    if(score>bestScore){bestScore=score;best=master}
  }
  return bestScore>=25?best:null;
}

function parseWhatsApp(txt){
  const names=[];const lines=txt.split('\n').map(l=>l.trim()).filter(Boolean);
  for(const l of lines){
    let cl=l.replace(/^[\d:.\s]+/,'').replace(/Hier,?\s*\d{1,2}:\d{2}/gi,'').replace(/Votes du sondage/gi,'').trim();
    if(cl.length<2||cl.length>50)continue;
    if(/^(en ligne|hier|aujourd|vu |message|tap|appel|photo|video|vocal|Audio|Document|\+?\d{3,}|[@ğŸ”âš™ï¸ğŸ“ğŸ’¬]|\d+\s*[â˜…â­])/i.test(cl))continue;
    if(!/[a-zA-ZÃ€-Ã¿]{2,}/.test(cl))continue;
    // Strip emojis
    cl=cl.replace(/[\u{1F600}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F000}-\u{1F02F}\u{1F0A0}-\u{1F0FF}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}]/gu,'').trim();
    if(cl.length>1)names.push(cl);
  }
  return [...new Set(names)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILE UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pendingPat=[],pendingSpo=[];

function setupUZ(zid,fid,thid,pbid,pfid,sid,max,type){
  const z=document.getElementById(zid),f=document.getElementById(fid);
  z.onclick=()=>f.click();
  z.ondragover=e=>{e.preventDefault();z.classList.add('dg')};
  z.ondragleave=()=>z.classList.remove('dg');
  z.ondrop=e=>{e.preventDefault();z.classList.remove('dg');handleF(e.dataTransfer.files,type)};
  f.onchange=()=>handleF(f.files,type);
}

async function handleF(fl,type){
  const files=Array.from(fl).slice(0,type==='pat'?5:2);if(!files.length)return;
  const thEl=document.getElementById(type==='pat'?'thPat':'thSpo');
  const pbEl=document.getElementById(type==='pat'?'pbPat':'pbSpo');
  const pfEl=document.getElementById(type==='pat'?'pfPat':'pfSpo');
  const stEl=document.getElementById(type==='pat'?'stPat':'stSpo');
  thEl.innerHTML='';pbEl.style.display='block';
  for(const f of files){const img=document.createElement('img');img.className='th proc';img.src=URL.createObjectURL(f);thEl.appendChild(img)}
  stEl.textContent='â³ Initialisation OCR...';
  const w=await initOCR();const all=[];
  for(let i=0;i<files.length;i++){
    stEl.textContent=`â³ Analyse ${i+1}/${files.length}...`;pfEl.style.width=`${(i/files.length)*100}%`;
    try{const{data:{text}}=await w.recognize(files[i]);
      if(type==='pat')all.push(...parseDoctolib(text));
      else all.push(...parseWhatsApp(text));
    }catch(e){console.error(e)}
    thEl.children[i]?.classList.remove('proc');pfEl.style.width=`${((i+1)/files.length)*100}%`;
  }
  if(type==='pat'){
    const seen=new Set();pendingPat=all.filter(p=>{const k=pid(p.name);if(seen.has(k))return false;seen.add(k);return true});
    stEl.textContent=`âœ… ${pendingPat.length} patients dÃ©tectÃ©s`;
  }else{
    // Match to master list
    const matched=[];
    for(const raw of all){
      const m=matchSportif(raw);
      if(m)matched.push(m);
    }
    pendingSpo=[...new Set(matched)];
    stEl.textContent=`âœ… ${pendingSpo.length} sportifs reconnus : ${pendingSpo.map(n=>n.split(' ').pop()).join(', ')}`;
  }
  if(pendingPat.length||pendingSpo.length)document.getElementById('btnGo').style.display='block';
}

setupUZ('uzPat','fPat','thPat','pbPat','pfPat','stPat',5,'pat');
setupUZ('uzSpo','fSpo','thSpo','pbSpo','pfSpo','stSpo',2,'spo');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btnGo').onclick=()=>{
  if(!pendingPat.length&&!pendingSpo.length)return;
  const msg=[];
  if(pendingPat.length)msg.push(`${pendingPat.length} patients`);
  if(pendingSpo.length)msg.push(`${pendingSpo.length} sportifs`);
  confirm_('Valider ?',`${msg.join(' et ')} seront traitÃ©s.`,doProcess);
};

function doProcess(){
  const todayStr=td();
  // Process patients
  for(const p of pendingPat){
    const id=pid(p.name);
    if(!DB.patients[id]){
      DB.patients[id]={name:p.name,time:p.time,group:'jourj',sessions:[],billings:[],special:[]};
    }else{
      DB.patients[id].time=p.time;
    }
    const pd_=presDate(DB.patients[id].group);
    if(!DB.patients[id].sessions.includes(pd_))DB.patients[id].sessions.push(pd_);
    DB.patients[id].sessions.sort();
  }
  // Process sportifs
  for(const name of pendingSpo){
    const id=pid(name);
    if(!DB.sportifs[id])DB.sportifs[id]={name,sessions:[],billings:[],special:[]};
    if(!DB.sportifs[id].sessions.includes(todayStr))DB.sportifs[id].sessions.push(todayStr);
    DB.sportifs[id].sessions.sort();
  }
  DB.lastUpload=todayStr;save();
  toast(`Traitement OK`,'ok');
  // Show assign modal for new patients
  const newP=pendingPat.filter(p=>{const id=pid(p.name);return DB.patients[id]&&DB.patients[id].sessions.length<=1});
  if(newP.length)modalAssign(newP);
  else{checkAlerts();switchTab('groups')}
  pendingPat=[];pendingSpo=[];
  document.getElementById('btnGo').style.display='none';
}

function modalAssign(pts){
  let h=`<h3>ğŸ†• Assignation nouveaux patients</h3><p>Choisissez le groupe :</p><div style="max-height:55vh;overflow-y:auto">`;
  for(const p of pts){
    const id=pid(p.name);
    h+=`<div style="display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--bdr)">
      <span style="flex:1;font-size:.82rem">${p.name}</span>
      <span style="font-family:'JetBrains Mono';font-size:.68rem;color:var(--tx2)">${p.time}</span>
      <select id="ga_${id}" style="background:var(--bg);color:var(--tx);border:1px solid var(--bdr);border-radius:6px;padding:4px 6px;font-size:.72rem">
        <option value="jourj">Jour J</option><option value="lendemain">J+1</option></select></div>`;
  }
  h+=`</div><div class="ma"><button class="btn btn-p btn-sm" id="gaBtn">Enregistrer</button></div>`;
  modal(h);
  document.getElementById('gaBtn').onclick=()=>{
    for(const p of pts){
      const id=pid(p.name);const sel=document.getElementById('ga_'+id);
      if(sel){
        DB.patients[id].group=sel.value;
        // Fix presence date
        const todayStr=td(),tmrw=nextDay(todayStr);
        DB.patients[id].sessions=DB.patients[id].sessions.filter(s=>s!==todayStr&&s!==tmrw);
        const pd_=presDate(sel.value);
        if(!DB.patients[id].sessions.includes(pd_))DB.patients[id].sessions.push(pd_);
        DB.patients[id].sessions.sort();
      }
    }
    save();closeM();toast('Groupes enregistrÃ©s','ok');checkAlerts();switchTab('groups');
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAlerts(){
  const c=document.getElementById('alGrp');c.innerHTML='';
  const jj=Object.values(DB.patients).filter(p=>p.group==='jourj'&&active(p));
  const ll=Object.values(DB.patients).filter(p=>p.group==='lendemain'&&active(p));
  const tot=jj.length+ll.length;if(!tot)return;
  const diff=Math.abs(jj.length-ll.length)/Math.max(jj.length,ll.length,1);
  if(diff>.2){
    const bg=jj.length>ll.length?'jourj':'lendemain';
    c.innerHTML+=`<div class="al al-w">âš ï¸ DÃ©sÃ©quilibre ${Math.round(diff*100)}% : ${jj.length} Jour J vs ${ll.length} J+1
      <button class="btn btn-sm btn-s" style="margin-left:6px;flex-shrink:0" onclick="modalRebal('${bg}')">RÃ©Ã©quilibrer</button></div>`;
  }
  if(jj.length>35)c.innerHTML+=`<div class="al al-d">ğŸš¨ Jour J : ${jj.length} patients (>35) <button class="btn btn-sm btn-s" style="margin-left:6px;flex-shrink:0" onclick="modalRebal('jourj')">RÃ©affecter</button></div>`;
  if(ll.length>35)c.innerHTML+=`<div class="al al-d">ğŸš¨ J+1 : ${ll.length} patients (>35) <button class="btn btn-sm btn-s" style="margin-left:6px;flex-shrink:0" onclick="modalRebal('lendemain')">RÃ©affecter</button></div>`;
}

function modalRebal(from){
  const pts=Object.entries(DB.patients).filter(([_,p])=>p.group===from&&active(p)).sort((a,b)=>a[1].name.localeCompare(b[1].name));
  const tgt=from==='jourj'?'Lendemain':'Jour J',tk=from==='jourj'?'lendemain':'jourj';
  let h=`<h3>Basculer vers ${tgt}</h3><p>Cochez les patients Ã  dÃ©placer :</p><div style="max-height:55vh;overflow-y:auto">`;
  for(const[id,p]of pts)h+=`<div class="pi" onclick="this.querySelector('.ck').classList.toggle('on')"><div class="ck" data-id="${id}"></div><span class="tm">${p.time||'--'}</span><span class="nm">${p.name}</span></div>`;
  h+=`</div><div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="rbBtn">Basculer</button></div>`;
  modal(h);
  document.getElementById('rbBtn').onclick=()=>{
    const sel=document.querySelectorAll('.ck.on');if(!sel.length){closeM();return}
    confirm_('Confirmer ?',`${sel.length} patient(s) â†’ ${tgt}`,()=>{
      sel.forEach(c=>{
        const id=c.dataset.id;DB.patients[id].group=tk;
        const todayStr=td(),tmrw=nextDay(todayStr);
        DB.patients[id].sessions=DB.patients[id].sessions.filter(s=>s!==todayStr&&s!==tmrw);
        const pd_=presDate(tk);
        if(!DB.patients[id].sessions.includes(pd_))DB.patients[id].sessions.push(pd_);
        DB.patients[id].sessions.sort();
      });
      save();toast(`${sel.length} basculÃ©(s)`,'ok');checkAlerts();renderGrp();
    });
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER GROUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrp(){
  checkAlerts();
  const c=document.getElementById('grpList');
  const sr=document.getElementById('srGrp').value.toLowerCase();
  const fl=document.querySelector('.tgb.on')?.dataset.f||'all';
  const pts=Object.entries(DB.patients)
    .filter(([_,p])=>active(p))
    .filter(([_,p])=>fl==='all'||p.group===fl)
    .filter(([_,p])=>!sr||p.name.toLowerCase().includes(sr))
    .sort((a,b)=>(a[1].time||'99').localeCompare(b[1].time||'99'));
  document.getElementById('cJ').textContent=Object.values(DB.patients).filter(p=>p.group==='jourj'&&active(p)).length;
  document.getElementById('cL').textContent=Object.values(DB.patients).filter(p=>p.group==='lendemain'&&active(p)).length;
  if(!pts.length){c.innerHTML='<div class="ey"><div class="em">ğŸ“‹</div><p>Aucun patient actif</p></div>';return}
  let h='';
  for(const[id,p]of pts){
    const tc=p.group==='jourj'?'tg-j':'tg-l',tl=p.group==='jourj'?'JOUR J':'J+1';
    const ss=p.sessions.length,lb=p.billings.length?p.billings[p.billings.length-1]:null;
    const sb=lb?p.sessions.filter(s=>s>lb).length:ss;
    h+=`<div class="pi" onclick="modalPatient('${id}')"><span class="tm">${p.time||'--'}</span><span class="nm">${p.name}</span><span class="tg ${tc}">${tl}</span><span style="font-size:.62rem;color:var(--tx2)">${ss}s</span></div>`;
  }
  c.innerHTML=h;
}
document.getElementById('srGrp').oninput=renderGrp;
document.querySelectorAll('.tgb').forEach(b=>b.onclick=()=>{document.querySelectorAll('.tgb').forEach(x=>x.classList.remove('on'));b.classList.add('on');renderGrp()});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PATIENT DETAIL + CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function modalPatient(id){
  const p=DB.patients[id];if(!p)return;
  showPersonCalendar(id,'patient',p);
}

function showPersonCalendar(id,type,person){
  const name=person.name;
  const group=type==='patient'?person.group:null;
  const sessions=person.sessions||[];
  const billings=person.billings||[];
  const specials=person.special||[];
  const ss=sessions.length,bs=billings.length;
  const lb=bs?billings[bs-1]:null;
  const sb=lb?sessions.filter(s=>s>lb).length:ss;

  let groupTag='';
  if(type==='patient'){
    groupTag=`<span class="tg ${group==='jourj'?'tg-j':'tg-l'}" style="padding:4px 10px;font-size:.72rem">${group==='jourj'?'ğŸŸ¢ Jour J':'ğŸ”µ Lendemain'}</span>`;
  }else{
    groupTag='<span class="tg tg-s" style="padding:4px 10px;font-size:.72rem">ğŸƒ Sportif</span>';
  }

  let h=`<h3>${name}</h3>
    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">${groupTag}
    ${type==='patient'?`<span style="font-family:'JetBrains Mono';font-size:.72rem;color:var(--tx2)">â° ${person.time||'--'}</span>`:''}</div>
    <div class="sg">
      <div class="sc"><div class="sv" style="font-size:1.1rem;color:var(--grn)">${ss}</div><div class="sl">SÃ©ances</div></div>
      <div class="sc"><div class="sv" style="font-size:1.1rem;color:var(--ylw)">${bs}</div><div class="sl">Factures</div></div>
    </div>
    <div id="calWidget"></div>
    <div class="lgd">
      <span><div class="ldot" style="background:var(--grn)"></div>PrÃ©sent</span>
      <span><div class="ldot" style="background:var(--ylw)"></div>FacturÃ©</span>
      <span><div class="ldot" style="background:var(--pur)"></div>SpÃ©cial</span>
      <span><div class="ldot" style="background:var(--blu);opacity:.3"></div>Jour peu chargÃ©</span>
    </div>
    <div class="ma" style="flex-wrap:wrap">
      <button class="btn btn-sm btn-s" onclick="addSpecialDay('${id}','${type}')">ğŸ“… Ajouter prÃ©sence spÃ©ciale</button>
      ${type==='patient'?`<button class="btn btn-sm btn-s" onclick="closeM();toggleGrp('${id}')">Changer groupe</button>`:'' }
      <button class="btn btn-sm btn-d" onclick="closeM();removePerson('${id}','${type}')">Supprimer</button>
      <button class="btn btn-sm btn-s" onclick="closeM()">Fermer</button>
    </div>`;
  modal(h);
  renderCalWidget(id,type,0);
}

function renderCalWidget(id,type,monthOffset){
  const person=type==='patient'?DB.patients[id]:DB.sportifs[id];
  if(!person)return;
  const cw=document.getElementById('calWidget');if(!cw)return;
  const now=new Date();
  const viewDate=new Date(now.getFullYear(),now.getMonth()+monthOffset,1);
  const year=viewDate.getFullYear(),month=viewDate.getMonth();
  const mNames=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
  const dNames=['L','M','M','J','V','S','D'];
  const firstDay=(new Date(year,month,1).getDay()+6)%7;
  const daysInMonth=new Date(year,month+1,0).getDate();
  const todayStr=td();

  // Compute daily load (all patients + sportifs) for this month
  const dailyLoad={};
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let count=0;
    for(const p of Object.values(DB.patients)){if(p.sessions.includes(ds)||(p.special&&p.special.includes(ds)))count++}
    for(const s of Object.values(DB.sportifs)){if(s.sessions.includes(ds)||(s.special&&s.special.includes(ds)))count++}
    dailyLoad[ds]=count;
  }
  const loads=Object.values(dailyLoad).filter(v=>v>0);
  const minLoad=loads.length?Math.min(...loads):0;

  const sessions=new Set(person.sessions||[]);
  const billings=new Set(person.billings||[]);
  const specials=new Set(person.special||[]);

  let html=`<div class="cal">
    <div class="cal-hdr">
      <button onclick="renderCalWidget('${id}','${type}',${monthOffset-1})">â—€</button>
      <span>${mNames[month]} ${year}</span>
      <button onclick="renderCalWidget('${id}','${type}',${monthOffset+1})" ${monthOffset>=0?'disabled style="opacity:.3"':''}>â–¶</button>
    </div>
    <div class="cal-grid">`;
  for(const dn of dNames)html+=`<div class="cal-day">${dn}</div>`;
  // Empty cells before first day
  for(let i=0;i<firstDay;i++)html+=`<div class="cal-cell other"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const isToday=ds===todayStr;
    const hasSess=sessions.has(ds);
    const hasBill=billings.has(ds);
    const hasSpec=specials.has(ds);
    const isLow=dailyLoad[ds]>0&&dailyLoad[ds]===minLoad;
    let cls='cal-cell';
    if(isToday)cls+=' today';
    if(isLow)cls+=' low-day';
    if(hasSpec)cls+=' special-day';
    let dots='';
    if(hasSess)dots+=`<div class="dot" style="background:var(--grn)"></div>`;
    if(hasBill)dots+=`<div class="dot" style="background:var(--ylw)"></div>`;
    if(hasSpec)dots+=`<div class="dot" style="background:var(--pur)"></div>`;
    html+=`<div class="${cls}" title="${ds}: ${dailyLoad[ds]||0} prÃ©sences"><span>${d}</span><div class="dots">${dots}</div></div>`;
  }
  html+=`</div></div>`;
  cw.innerHTML=html;
}

function addSpecialDay(id,type){
  // Show date picker
  const person=type==='patient'?DB.patients[id]:DB.sportifs[id];
  const inner=document.querySelector('.ml');
  if(!inner)return;
  // Inject a date input overlay
  const overlay=document.createElement('div');
  overlay.style.cssText='margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--bdr);border-radius:10px';
  overlay.innerHTML=`
    <p style="font-size:.78rem;color:var(--tx2);margin-bottom:8px">SÃ©lectionnez la date de prÃ©sence spÃ©ciale :</p>
    <input type="date" class="si" id="specDate" value="${td()}" max="${td()}">
    <div class="ma">
      <button class="btn btn-sm btn-s" onclick="this.closest('div[style]').remove()">Annuler</button>
      <button class="btn btn-sm btn-p" id="specOk">Ajouter</button>
    </div>`;
  inner.appendChild(overlay);
  document.getElementById('specOk').onclick=()=>{
    const date=document.getElementById('specDate').value;
    if(!date){toast('Date requise','err');return}
    confirm_('Ajouter prÃ©sence spÃ©ciale ?',`${person.name} sera marquÃ© prÃ©sent le ${new Date(date).toLocaleDateString('fr-FR')} (spÃ©cial)`,()=>{
      if(!person.special)person.special=[];
      if(!person.special.includes(date)){person.special.push(date);person.special.sort()}
      save();toast('PrÃ©sence spÃ©ciale ajoutÃ©e','ok');
      closeM();showPersonCalendar(id,type,person);
    });
  };
}

function toggleGrp(id){
  const p=DB.patients[id];const ng=p.group==='jourj'?'lendemain':'jourj',lb=ng==='jourj'?'Jour J':'Lendemain';
  confirm_('Changer ?',`${p.name} â†’ ${lb}`,()=>{DB.patients[id].group=ng;save();toast(`â†’ ${lb}`,'ok');renderGrp()});
}
function removePerson(id,type){
  const name=type==='patient'?DB.patients[id]?.name:DB.sportifs[id]?.name;
  confirm_('Supprimer ?',`${name} sera supprimÃ© dÃ©finitivement.`,()=>{
    if(type==='patient')delete DB.patients[id];else delete DB.sportifs[id];
    save();toast('SupprimÃ©','ok');renderGrp();renderSpo();renderHist();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD PATIENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function modalAddPatient(){
  modal(`<h3>â• Ajouter patient</h3>
    <input class="si" id="npN" placeholder="Nom (ex: DUPONT Marie)">
    <input class="si" id="npT" placeholder="Heure (ex: 10:30)">
    <select class="si" id="npG" style="margin-bottom:10px"><option value="jourj">Jour J</option><option value="lendemain">Lendemain</option></select>
    <div class="ma"><button class="btn btn-s btn-sm" onclick="closeM()">Annuler</button><button class="btn btn-p btn-sm" id="apBtn">Ajouter</button></div>`);
  document.getElementById('apBtn').onclick=()=>{
    const n=document.getElementById('npN').value.trim(),t=document.getElementById('npT').value.trim(),g=document.getElementById('npG').value;
    if(!n){toast('Nom requis','err');return}
    confirm_('Ajouter ?',`${n} â†’ ${g==='jourj'?'Jour J':'Lendemain'}`,()=>{
      const id=pid(n);
      DB.patients[id]={name:n,time:t,group:g,sessions:[presDate(g)],billings:[],special:[]};
      save();toast(`${n} ajoutÃ©`,'ok');renderGrp();
    });
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BILLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function computeBilling(){
  if(!isUD())return[];
  const todayStr=td(),cands=[];
  for(const[id,p]of Object.entries(DB.patients)){
    if(!active(p))continue;
    if(p.billings.includes(todayStr))continue;
    const freq=p.group==='jourj'?3:5;
    const lb=p.billings.length?p.billings[p.billings.length-1]:null;
    const sb=lb?p.sessions.filter(s=>s>lb).length:p.sessions.length;
    if(sb>=freq){
      cands.push({id,p,sb,freq,urg:sb/freq,lb,time:p.time||'99:99',hour:parseInt((p.time||'99').split(':')[0])||99});
    }
  }
  // Sort by urgency desc (most overdue first), then oldest billing first
  cands.sort((a,b)=>{
    if(b.urg!==a.urg)return b.urg-a.urg;
    const la=a.lb||'1970';const lbt=b.lb||'1970';
    return la.localeCompare(lbt);
  });
  // Max 3 per hour
  const hourSlots={},sel=[];
  for(const c of cands){
    const h=c.hour;if(!hourSlots[h])hourSlots[h]=0;
    if(hourSlots[h]<3){sel.push(c);hourSlots[h]++}
  }
  return sel;
}

function renderBill(){
  const c=document.getElementById('billList'),bc=document.getElementById('billedList');
  const todayStr=td();
  if(!isUD()){c.innerHTML='<div class="al al-i">ğŸ’¡ Facturation les lundis et jeudis uniquement.</div>';bc.innerHTML='';return}
  const toBill=computeBilling();
  const done=Object.entries(DB.patients).filter(([_,p])=>p.billings.includes(todayStr)).sort((a,b)=>(a[1].time||'').localeCompare(b[1].time||''));
  if(!toBill.length)c.innerHTML='<div class="ey"><div class="em">âœ…</div><p>Aucun patient Ã  facturer</p></div>';
  else{
    let h='';
    for(const x of toBill){
      const gc=x.p.group==='jourj'?'tg-j':'tg-l',gl=x.p.group==='jourj'?'J':'J+1';
      h+=`<div class="pi" style="border-left:3px solid var(--ylw)">
        <span class="tm">${x.p.time||'--'}</span><span class="nm">${x.p.name}</span>
        <span class="tg ${gc}" style="font-size:.55rem">${gl}</span>
        <span class="tg tg-f">${x.sb}s</span>
        <button class="btn btn-sm btn-p" onclick="doBill('${x.id}')">ğŸ’³</button></div>`;
    }
    c.innerHTML=h;
  }
  if(!done.length)bc.innerHTML='<p style="color:var(--tx2);font-size:.78rem;padding:6px">Aucun</p>';
  else{
    let h='';
    for(const[id,p]of done)h+=`<div class="pi" style="border-left:3px solid var(--grn)"><span class="tm">${p.time||'--'}</span><span class="nm">${p.name}</span><span class="tg tg-ok">âœ“</span><button class="btn btn-sm btn-d" onclick="unBill('${id}')" title="Annuler">âœ•</button></div>`;
    bc.innerHTML=h;
  }
}

function doBill(id){
  const p=DB.patients[id];
  confirm_('Facturer ?',`${p.name} â€” confirmer la facturation ?`,()=>{
    const todayStr=td();
    // For lendemain patients: presence & billing recorded today (jour J), not tomorrow
    if(p.group==='lendemain'){
      // Remove tomorrow's presence, add today
      const tmrw=nextDay(todayStr);
      p.sessions=p.sessions.filter(s=>s!==tmrw);
      if(!p.sessions.includes(todayStr))p.sessions.push(todayStr);
      p.sessions.sort();
    }
    if(!p.billings.includes(todayStr)){p.billings.push(todayStr);p.billings.sort()}
    if(!DB.dailyBills[todayStr])DB.dailyBills[todayStr]=0;DB.dailyBills[todayStr]++;
    save();toast(`${p.name} facturÃ© âœ“`,'ok');renderBill();
  });
}

function unBill(id){
  const p=DB.patients[id];
  confirm_('Annuler ?',`Annuler la facturation de ${p.name} ?`,()=>{
    const todayStr=td();p.billings=p.billings.filter(b=>b!==todayStr);
    if(DB.dailyBills[todayStr])DB.dailyBills[todayStr]--;
    // If lendemain patient, restore tomorrow's presence
    if(p.group==='lendemain'){
      p.sessions=p.sessions.filter(s=>s!==todayStr);
      const tmrw=nextDay(todayStr);
      if(!p.sessions.includes(tmrw))p.sessions.push(tmrw);
      p.sessions.sort();
    }
    save();toast('AnnulÃ©','ok');renderBill();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPORTIFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSpo(){
  const c=document.getElementById('spoList'),bc=document.getElementById('spoBill');
  const todayStr=td();
  const actives=Object.entries(DB.sportifs).filter(([_,s])=>{const l=s.sessions[s.sessions.length-1];return l&&(new Date(todayStr)-new Date(l))/864e5<14});
  if(!actives.length){c.innerHTML='<div class="ey"><div class="em">ğŸƒ</div><p>Aucun sportif actif</p></div>';bc.innerHTML='';return}
  let h='';
  for(const[id,s]of actives){
    const pres=s.sessions.includes(todayStr);
    h+=`<div class="pi" onclick="showPersonCalendar('${id}','sportif',DB.sportifs['${id}']);"><span class="nm">${s.name}</span><span class="tg tg-s">SPORT</span>${pres?'<span style="font-size:.68rem;color:var(--grn)">âœ“ PrÃ©sent</span>':''}</div>`;
  }
  c.innerHTML=h;
  // Sportif billing
  const toBill=chooseSpoToBill();
  if(toBill){
    const s=DB.sportifs[toBill];
    const wp=findMonThuPairs(s);
    let wpInfo='';
    if(wp.length){
      const lp=wp[wp.length-1];
      const mc=dailyBillCount(lp.mon),tc=dailyBillCount(lp.thu);
      const best=mc<=tc?'Lundi':'Jeudi';
      wpInfo=`<div class="al al-i" style="margin-top:8px">ğŸ“Š Semaine ${new Date(lp.mon).toLocaleDateString('fr-FR')} : ${best} moins facturÃ© (${Math.min(mc,tc)} vs ${Math.max(mc,tc)})</div>`;
    }
    bc.innerHTML=`<div class="pi" style="border-left:3px solid var(--org)"><span class="nm">${s.name}</span><span class="tg" style="background:var(--orgd);color:var(--org)">CV</span>
      <button class="btn btn-sm btn-p" onclick="billSpo('${toBill}')">ğŸ’³</button></div>${wpInfo}`;
  }else bc.innerHTML='<p style="color:var(--tx2);font-size:.78rem;padding:6px">Aucun sportif Ã  facturer</p>';
}

function chooseSpoToBill(){
  const todayStr=td();
  const cands=Object.entries(DB.sportifs).filter(([_,s])=>s.sessions.includes(todayStr)&&!s.billings.includes(todayStr));
  if(!cands.length)return null;
  cands.sort((a,b)=>{const la=a[1].billings.length?a[1].billings[a[1].billings.length-1]:'1970';const lb_=b[1].billings.length?b[1].billings[b[1].billings.length-1]:'1970';return la.localeCompare(lb_)});
  return cands[0][0];
}

function findMonThuPairs(s){
  const pairs=[];
  for(const sess of s.sessions){
    const d=new Date(sess);
    if(d.getDay()===1){const thu=new Date(d);thu.setDate(thu.getDate()+3);const ts=thu.toISOString().slice(0,10);if(s.sessions.includes(ts))pairs.push({mon:sess,thu:ts})}
  }
  return pairs;
}

function dailyBillCount(ds){
  let c=DB.dailyBills[ds]||0;
  for(const s of Object.values(DB.sportifs)){if(s.billings.includes(ds))c++}
  return c;
}

function billSpo(id){
  const s=DB.sportifs[id];
  confirm_('Carte vitale sportif ?',`${s.name} â€” confirmer ?`,()=>{
    const todayStr=td();
    if(!s.billings.includes(todayStr)){s.billings.push(todayStr);s.billings.sort()}
    if(!DB.dailyBills[todayStr])DB.dailyBills[todayStr]=0;DB.dailyBills[todayStr]++;
    save();toast(`${s.name} CV âœ“`,'ok');renderSpo();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY / CALENDAR VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHist(){
  const c=document.getElementById('histList');
  const sr=document.getElementById('srHist').value.toLowerCase();
  let h='';
  const pts=Object.entries(DB.patients).filter(([_,p])=>!sr||p.name.toLowerCase().includes(sr)).sort((a,b)=>a[1].name.localeCompare(b[1].name));
  if(pts.length){
    h+=`<div class="sh"><h3>Patients</h3><span style="font-size:.72rem;color:var(--tx2)">${pts.length}</span></div>`;
    for(const[id,p]of pts){
      h+=`<div class="pi" onclick="showPersonCalendar('${id}','patient',DB.patients['${id}'])"><span class="nm">${p.name}</span><span class="tg ${p.group==='jourj'?'tg-j':'tg-l'}" style="font-size:.55rem">${p.group==='jourj'?'J':'J+1'}</span><span style="font-size:.6rem;color:var(--tx2)">${p.sessions.length}s/${p.billings.length}f</span></div>`;
    }
  }
  const sps=Object.entries(DB.sportifs).filter(([_,s])=>!sr||s.name.toLowerCase().includes(sr)).sort((a,b)=>a[1].name.localeCompare(b[1].name));
  if(sps.length){
    h+=`<div class="sh" style="margin-top:16px"><h3>Sportifs</h3><span style="font-size:.72rem;color:var(--tx2)">${sps.length}</span></div>`;
    for(const[id,s]of sps){
      h+=`<div class="pi" onclick="showPersonCalendar('${id}','sportif',DB.sportifs['${id}'])"><span class="nm">${s.name}</span><span class="tg tg-s" style="font-size:.55rem">SPORT</span><span style="font-size:.6rem;color:var(--tx2)">${s.sessions.length}p/${s.billings.length}f</span></div>`;
    }
  }
  if(!h)h='<div class="ey"><div class="em">ğŸ“…</div><p>Aucun historique</p></div>';
  c.innerHTML=h;
}
document.getElementById('srHist').oninput=renderHist;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVICE WORKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
renderGrp();
</script>
</body>
</html>
